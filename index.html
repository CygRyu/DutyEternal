<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duty Eternal - Imperial Mission System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#8B0000',
                        accent: '#DAA520',
                        imperial: '#4169E1',
                        chaos: '#8B0000',
                        dark: {
                            DEFAULT: '#0A0A0A',
                            '50': '#1A1A1A',
                            '100': '#141414',
                            '200': '#121212',
                            '300': '#101010',
                            '400': '#0E0E0E',
                            '500': '#0C0C0C',
                            '600': '#0A0A0A',
                            '700': '#080808',
                            '800': '#060606',
                            '900': '#040404',
                        },
                        imperial: {
                            DEFAULT: '#DAA520',
                            '50': '#FFF8DC',
                            '100': '#F5DEB3',
                            '200': '#DAA520',
                            '300': '#B8860B',
                            '400': '#996633',
                            '500': '#8B4513',
                            '600': '#654321',
                            '700': '#4A2C17',
                            '800': '#2F1B14',
                            '900': '#1A0F0A',
                        },
                    },
                    fontFamily: {
                        gothic: ['Cinzel', 'serif'],
                        imperial: ['Crimson Text', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'toast-slide': 'toastSlide 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(218, 165, 32, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(218, 165, 32, 0.8)' },
                        },
                        toastSlide: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                    },
                    boxShadow: {
                        'imperial': '0 0 10px rgba(218, 165, 32, 0.3)',
                        'chaos': '0 0 10px rgba(139, 0, 0, 0.5)',
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Crimson+Text:wght@400;600;700&display=swap');
        
        :root {
            --primary: #8B0000;
            --accent: #DAA520;
            --imperial: #4169E1;
            --dark: #0A0A0A;
            --danger: #b91c1c;
            --success: #15803d;
        }
        
        body {
            font-family: 'Crimson Text', serif;
            background-color: var(--dark);
            color: var(--accent);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5z' fill='%23654321' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-attachment: fixed;
        }
        
        .gothic {
            font-family: 'Cinzel', serif;
        }
        
        .mission-card {
            background-image: linear-gradient(45deg, rgba(218, 165, 32, 0.05), rgba(139, 0, 0, 0.05));
            background-color: rgba(10, 10, 10, 0.95);
            border: 2px solid #654321;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: inset 0 0 10px rgba(218, 165, 32, 0.1);
        }
        
        .mission-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(218, 165, 32, 0.2), inset 0 0 15px rgba(218, 165, 32, 0.2);
            border-color: var(--accent);
        }
        
        .mission-card.new-mission {
            animation: glow 2s ease-in-out;
        }
        
        .mission-board {
            background-image: radial-gradient(circle at center, rgba(218, 165, 32, 0.1), transparent 50%);
            background-color: rgba(20, 20, 20, 0.9);
            border: 3px solid #654321;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(218, 165, 32, 0.1);
        }
        
        .resolve-heart {
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .resolve-heart.depleted {
            opacity: 0.2;
            filter: grayscale(100%);
        }
        
        .resolve-heart.active {
            color: #DAA520;
            text-shadow: 0 0 10px rgba(218, 165, 32, 0.8);
        }
        
        .priority-indicator {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 3px;
        }
        
        .priority-indicator div {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #654321;
            opacity: 0.3;
            border: 1px solid #DAA520;
        }
        
        .priority-indicator div.active {
            opacity: 1;
            background-color: #DAA520;
            box-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
        }
        
        .corrupted-ui {
            filter: sepia(20%) hue-rotate(320deg) saturate(150%);
            opacity: 0.9;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: rgba(10, 10, 10, 0.95);
            color: #DAA520;
            text-align: left;
            border: 1px solid #654321;
            padding: 12px;
            border-radius: 6px;
            position: absolute;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
            line-height: 1.4;
        }
        
        .tooltip-text.below {
            top: 125%;
            left: 50%;
            margin-left: -150px;
        }
        
        .tooltip-text.above {
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        /* Mobile responsive tab navigation */
        .tab-btn {
            transition: all 0.3s ease;
        }
        
        .tab-btn .tab-text {
            display: inline;
        }
        
        .tab-btn .tab-icon {
            margin-right: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .tab-btn .tab-text {
                display: none;
            }
            
            .tab-btn .tab-icon {
                margin-right: 0;
            }
            
            .tab-btn {
                min-width: 40px;
                justify-content: center;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.5);
        }
        
        ::-webkit-scrollbar-thumb {
            background: #654321;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #DAA520;
        }
        
        .activity-list-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        .modal-content {
            background-color: #1a1a1a;
            border: 3px solid #654321;
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9), inset 0 0 20px rgba(218, 165, 32, 0.1);
            overflow-y: auto;
        }
        
        @media (max-width: 640px) {
            .modal-content {
                padding: 1rem;
                margin: 0.5rem;
                max-height: 95vh;
            }
        }
        
        .free-completion {
            animation: emperorsBlessing 1.5s ease-in-out;
        }

        @keyframes emperorsBlessing {
            0% { box-shadow: 0 0 10px rgba(218, 165, 32, 0.3); }
            50% { box-shadow: 0 0 40px rgba(218, 165, 32, 1); }
            100% { box-shadow: 0 0 10px rgba(218, 165, 32, 0.3); }
        }

        .faction-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 1px solid;
        }

        .faction-space-marines {
            background-color: rgba(65, 105, 225, 0.2);
            border-color: #4169E1;
            color: #4169E1;
        }

        .faction-chaos {
            background-color: rgba(139, 0, 0, 0.2);
            border-color: #8B0000;
            color: #8B0000;
        }

        .faction-orks {
            background-color: rgba(34, 139, 34, 0.2);
            border-color: #228B22;
            color: #228B22;
        }

        .faction-eldar {
            background-color: rgba(138, 43, 226, 0.2);
            border-color: #8A2BE2;
            color: #8A2BE2;
        }

        .faction-imperial-guard {
            background-color: rgba(218, 165, 32, 0.2);
            border-color: #DAA520;
            color: #DAA520;
        }

        .buff-indicator {
            padding: 1px 4px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 4px;
        }

        .zeal-buff {
            background-color: rgba(65, 105, 225, 0.3);
            border: 1px solid #4169E1;
            color: #4169E1;
        }

        .duty-buff {
            background-color: rgba(218, 165, 32, 0.3);
            border: 1px solid #DAA520;
            color: #DAA520;
        }

        .heretical-buff {
            background-color: rgba(139, 0, 0, 0.3);
            border: 1px solid #8B0000;
            color: #8B0000;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            pointer-events: none;
        }

        .toast {
            background-color: rgba(10, 10, 10, 0.95);
            border: 1px solid #654321;
            color: #DAA520;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
            animation: toast-slide 0.3s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
            min-width: 250px;
            max-width: 400px;
        }

        .toast.success {
            border-color: #15803d;
            color: #22c55e;
        }

        .toast.error {
            border-color: #dc2626;
            color: #ef4444;
        }

        .special-mission {
            border: 2px solid;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.05), transparent);
        }

        .waaagh-mission {
            border-color: #228B22;
            box-shadow: 0 0 15px rgba(34, 139, 34, 0.5);
        }

        .warp-temptation {
            border-color: #8B0000;
            box-shadow: 0 0 15px rgba(139, 0, 0, 0.5);
        }

        .rank-progress-bar {
            height: 6px;
            background-color: rgba(20, 20, 20, 0.8);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid #654321;
        }

        .rank-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #654321, #DAA520);
            transition: width 0.5s ease;
        }

        .paragon-indicator {
            background: linear-gradient(45deg, #DAA520, #FFD700);
            color: #0A0A0A;
            font-weight: bold;
        }

        .rank-benefit {
            background-color: rgba(218, 165, 32, 0.1);
            border: 1px solid rgba(218, 165, 32, 0.3);
            border-radius: 4px;
            padding: 8px;
            margin: 4px 0;
            font-size: 0.8rem;
        }

        .rank-benefit.heretical {
            background-color: rgba(139, 0, 0, 0.1);
            border-color: rgba(139, 0, 0, 0.3);
            color: #8B0000;
        }

        .waaagh-button {
            background: linear-gradient(45deg, #228B22, #32CD32);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .waaagh-button:hover {
            background: linear-gradient(45deg, #32CD32, #228B22);
        }

        .waaagh-button:disabled {
            background: #666;
            color: #ccc;
            cursor: not-allowed;
        }

        .artifact-card {
            background-color: rgba(16, 16, 16, 0.9);
            border: 2px solid #654321;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .artifact-card.equipped {
            border-color: #DAA520;
            background-color: rgba(218, 165, 32, 0.1);
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.3);
        }

        .artifact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(218, 165, 32, 0.2);
        }

        .artifact-rarity-common {
            color: #9CA3AF;
        }

        .artifact-rarity-rare {
            color: #3B82F6;
        }

        .artifact-rarity-legendary {
            color: #F59E0B;
            text-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
        }

        .artifact-grid {
            max-height: 400px;
            overflow-y: auto;
        }

        .diminishing-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #F59E0B;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <header class="py-4 px-4 sm:px-6 border-b border-accent/30 bg-dark-400 shadow-lg">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <div class="flex items-center mb-4 sm:mb-0">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='48' height='48' viewBox='0 0 24 24' fill='none' stroke='%23DAA520' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10 9 10s9-4.45 9-10V7L12 2z'/%3E%3Cpath d='M12 22s8-4 8-10V7l-8-5-8 5v5c0 6 8 10 8 10z'/%3E%3C/svg%3E" alt="Imperial Aquila" class="h-12 w-12 mr-3">
                <div>
                    <h1 class="text-3xl gothic font-bold text-accent">Duty Eternal</h1>
                    <p class="text-xs text-accent/70">Imperial Mission System</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="mr-4 flex items-center">
                    <span id="resolve-info" class="text-sm mr-2">Resolve:</span>
                    <div id="resolve-display" class="flex">
                        <div class="resolve-heart active">‚ö°</div>
                        <div class="resolve-heart active">‚ö°</div>
                        <div class="resolve-heart active">‚ö°</div>
                        <div class="resolve-heart active">‚ö°</div>
                        <div class="resolve-heart active">‚ö°</div>
                    </div>
                    <div id="resolve-timer" class="text-xs text-accent/60 ml-2"></div>
                </div>
                
                <div class="text-center">
                    <div class="tooltip relative">
                        <div id="faction-display" class="faction-badge faction-space-marines cursor-help">Space Marines</div>
                        <div id="faction-buffs-display" class="text-xs mt-1"></div>
                        <div class="tooltip-text below" id="faction-tooltip-header">
                            <strong>Space Marines - The Emperor's Finest</strong><br>
                            ‚Ä¢ Favor high-priority tasks (Scale 4-5 get 50% selection boost)<br>
                            ‚Ä¢ Complete 3 missions in a row to gain "Zeal" (next mission costs -1 Resolve)<br>
                            ‚Ä¢ Stoic and disciplined approach to all duties
                        </div>
                    </div>
                    <div class="text-xs text-accent/70 mt-1">
                        <span id="current-rank">Initiate</span>
                        <span id="paragon-display" class="paragon-indicator px-1 rounded ml-1 hidden">P0</span>
                    </div>
                    <div class="rank-progress-bar mt-1 w-24">
                        <div id="rank-progress-fill" class="rank-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container mx-auto mt-4">
            <nav class="flex">
                <button class="tab-btn group active px-2 sm:px-4 py-2 gothic text-accent hover:bg-accent/20 transition-colors rounded-t-lg border-b-2 border-accent relative flex items-center justify-center" data-tab="missions">
                    <i class="fas fa-scroll tab-icon"></i>
                    <span class="tab-text">Mission Board</span>
                    <div class="tooltip-text above">Access the Emperor's sacred decrees and assign missions to purge idleness from your soul</div>
                </button>
                <button class="tab-btn group px-2 sm:px-4 py-2 gothic text-accent hover:bg-accent/20 transition-colors rounded-t-lg border-b-2 border-transparent relative flex items-center justify-center" data-tab="armory">
                    <i class="fas fa-shield-alt tab-icon"></i>
                    <span class="tab-text">Armory</span>
                    <div class="tooltip-text above">Equip blessed relics and cursed artifacts to enhance your resolve in battle</div>
                </button>
                <button class="tab-btn group px-2 sm:px-4 py-2 gothic text-accent hover:bg-accent/20 transition-colors rounded-t-lg border-b-2 border-transparent relative flex items-center justify-center" data-tab="archives">
                    <i class="fas fa-book tab-icon"></i>
                    <span class="tab-text">Archives</span>
                    <div class="tooltip-text above">Inscribe and manage your sacred duties to serve the Imperium's eternal will</div>
                </button>
                <button class="tab-btn group px-2 sm:px-4 py-2 gothic text-accent hover:bg-accent/20 transition-colors rounded-t-lg border-b-2 border-transparent relative flex items-center justify-center" data-tab="tactical">
                    <i class="fas fa-chart-line tab-icon"></i>
                    <span class="tab-text">Tactical Slate</span>
                    <div class="tooltip-text above">Review your valorous deeds and track your eternal service to the Emperor</div>
                </button>
                <button class="tab-btn group px-2 sm:px-4 py-2 gothic text-accent hover:bg-accent/20 transition-colors rounded-t-lg border-b-2 border-transparent relative flex items-center justify-center" data-tab="settings">
                    <i class="fas fa-cog tab-icon"></i>
                    <span class="tab-text">Settings</span>
                    <div class="tooltip-text above">Command your allegiance and calibrate the Vox-Caster for strategic guidance</div>
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-6">
        <!-- Mission Board Tab -->
        <div id="missions-tab" class="tab-content active">
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <h2 class="text-2xl gothic font-semibold mb-2">Imperial Mission Board</h2>
                    <p class="text-accent/70 italic mb-4">Accept the Emperor's decrees and purge procrastination from your soul</p>
                    <div id="daily-progress" class="mb-2">
                        <span class="text-sm text-accent/80">Daily Missions Completed: <span id="missions-completed-today">0</span></span>
                        <div class="w-48 h-2 bg-dark-900 rounded overflow-hidden border border-accent/30">
                            <div id="daily-progress-bar" class="h-full bg-accent" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="diminishing-returns-warning" class="hidden diminishing-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="diminishing-message">Diminishing returns active</span>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row mt-4 sm:mt-0">
                    <!-- WAAAGH! Button for Orks -->
                    <div id="waaagh-button-container" class="hidden mr-4 mb-2 sm:mb-0">
                        <button id="waaagh-button" class="waaagh-button px-4 py-2 rounded font-bold transition-all">
                            <i class="fas fa-fist-raised mr-2"></i> WAAAGH! (2 Resolve)
                        </button>
                    </div>
                    
                    <div class="flex">
                        <div class="mr-4">
                            <label for="mission-count" class="block text-sm text-accent/80 mb-1">Mission Count:</label>
                            <select id="mission-count" class="bg-dark-500 text-accent border border-accent/50 rounded py-1 px-2 text-base">
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        
                        <div>
                            <button id="generate-missions" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors flex items-center">
                                <i class="fas fa-plus mr-2"></i> Receive Missions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="mission-warning" class="hidden mb-4 p-4 bg-amber-900/20 border border-amber-600/50 text-amber-200 rounded">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span id="warning-message">The Emperor's will shall be done.</span>
            </div>
            
            <div id="corruption-warning" class="hidden mb-4 p-4 bg-red-900/20 border border-red-600/50 text-red-200 rounded">
                <i class="fas fa-skull mr-2"></i>
                <span>The taint of Chaos consumes you! Mission completion costs 2 Resolve. Complete 3 missions without abandoning any to purge the corruption.</span>
            </div>
            
            <div id="mission-board" class="p-6 mission-board rounded-lg">
                <div id="empty-mission-prompt" class="text-center py-16">
                    <i class="fas fa-scroll text-5xl text-accent/30 mb-4"></i>
                    <h3 class="text-xl gothic mb-2">No Active Missions</h3>
                    <p class="text-accent/50 mb-6">The Emperor awaits your service. Add duties and receive missions to begin</p>
                    <button id="empty-add-duty-btn" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors">
                        <i class="fas fa-plus mr-2"></i> Add Your First Duty
                    </button>
                </div>
                
                <div id="mission-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Mission cards will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- Armory Tab -->
        <div id="armory-tab" class="tab-content">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h2 class="text-2xl gothic font-semibold mb-2">Sacred Armory</h2>
                    <p class="text-accent/70 italic">Blessed relics, cursed artifacts, and the glory of rank</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Rank Benefits</h3>
                    <div id="rank-benefits">
                        <p class="text-accent/50 text-center py-8">Complete missions to unlock rank benefits</p>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Artifacts</h3>
                    <div class="mb-3 text-sm text-accent/70">
                        Storage: <span id="artifact-storage-count">0</span> / 10
                        <span class="ml-2">Equipped: <span id="artifact-equipped-count">0</span> / <span id="artifact-max-equipped">1</span></span>
                    </div>
                    <div id="artifacts-container">
                        <p class="text-accent/50 text-center py-8">No artifacts discovered yet</p>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Paragon Benefits</h3>
                    <div id="paragon-benefits">
                        <p class="text-accent/50 text-center py-8">Reach max rank to begin Paragon progression</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Archives Tab -->
        <div id="archives-tab" class="tab-content">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h2 class="text-2xl gothic font-semibold mb-2">Imperial Archives</h2>
                    <p class="text-accent/70 italic">Record and manage your sacred duties</p>
                </div>
                
                <button id="add-duty-btn" class="mt-4 sm:mt-0 bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors">
                    <i class="fas fa-plus mr-2"></i> Add New Duty
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Duty Form -->
                <div id="duty-form-container" class="hidden bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">
                        <span id="form-title">Inscribe New Duty</span>
                    </h3>
                    
                    <form id="duty-form" class="space-y-4">
                        <input type="hidden" id="duty-id" value="">
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="duty-type" class="block text-sm text-accent/80 mb-1">Type</label>
                                <div class="relative">
                                    <select id="duty-type" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base">
                                        <option value="Read">Read</option>
                                        <option value="Play">Play</option>
                                        <option value="Watch">Watch</option>
                                        <option value="Listen">Listen</option>
                                        <option value="Practice">Practice</option>
                                        <option value="Learn">Learn</option>
                                        <option value="Work">Work</option>
                                        <option value="Exercise">Exercise</option>
                                        <option value="Cook">Cook</option>
                                        <option value="Clean">Clean</option>
                                        <option value="Social">Social</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="text" id="custom-type" class="hidden w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base mt-2" placeholder="Enter custom type...">
                                </div>
                            </div>
                            
                            <div>
                                <label for="duty-object" class="block text-sm text-accent/80 mb-1">Object</label>
                                <div class="relative">
                                    <select id="duty-object" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base">
                                        <option value="Book">Book</option>
                                        <option value="Manga">Manga</option>
                                        <option value="Comic">Comic</option>
                                        <option value="Video Game">Video Game</option>
                                        <option value="Board Game">Board Game</option>
                                        <option value="Movie">Movie</option>
                                        <option value="TV Show">TV Show</option>
                                        <option value="Anime">Anime</option>
                                        <option value="Podcast">Podcast</option>
                                        <option value="Music">Music</option>
                                        <option value="Instrument">Instrument</option>
                                        <option value="Language">Language</option>
                                        <option value="Project">Project</option>
                                        <option value="Recipe">Recipe</option>
                                        <option value="Room">Room</option>
                                        <option value="Event">Event</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="text" id="custom-object" class="hidden w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base mt-2" placeholder="Enter custom object...">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="duty-name" class="block text-sm text-accent/80 mb-1">Subject Name</label>
                            <input type="text" id="duty-name" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base" placeholder="e.g. Horus Heresy, Space Marine Training, etc.">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div class="col-span-1">
                                <label for="duty-target-type" class="block text-sm text-accent/80 mb-1">Target Type</label>
                                <select id="duty-target-type" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base">
                                    <option value="at-least">At least</option>
                                    <option value="range">Range</option>
                                </select>
                            </div>
                            
                            <div class="col-span-1">
                                <label for="duty-target-min" class="block text-sm text-accent/80 mb-1">Min Value</label>
                                <input type="number" id="duty-target-min" min="1" value="30" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base">
                            </div>
                            
                            <div class="col-span-1">
                                <label for="duty-target-max" class="block text-sm text-accent/80 mb-1">Max Value</label>
                                <input type="number" id="duty-target-max" min="1" value="60" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base" disabled>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="duty-unit" class="block text-sm text-accent/80 mb-1">Unit</label>
                                <div class="relative">
                                    <select id="duty-unit" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base">
                                        <option value="pages">pages</option>
                                        <option value="chapters">chapters</option>
                                        <option value="episodes">episodes</option>
                                        <option value="minutes">minutes</option>
                                        <option value="hours">hours</option>
                                        <option value="levels">levels</option>
                                        <option value="exercises">exercises</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="text" id="custom-unit" class="hidden w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base mt-2" placeholder="Enter custom unit...">
                                </div>
                            </div>
                            
                            <div>
                                <label for="duty-priority" class="block text-sm text-accent/80 mb-1">
                                    Priority Level
                                    <span class="tooltip relative ml-1">
                                        <i class="fas fa-question-circle text-accent/50"></i>
                                        <span class="tooltip-text above">Higher priority duties are more likely to be selected as missions</span>
                                    </span>
                                </label>
                                <div class="flex items-center">
                                    <input type="range" id="duty-priority" min="1" max="5" value="3" class="w-full bg-dark-300 accent-accent">
                                    <span id="priority-value" class="ml-2 text-accent/80 min-w-[24px]">3</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="duty-icon" class="block text-sm text-accent/80 mb-1">
                                Icon
                            </label>
                            <div class="flex flex-wrap gap-2 p-2 bg-dark-400 border border-accent/30 rounded max-h-[120px] overflow-y-auto">
                                <button type="button" data-icon="üìö" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üìö</button>
                                <button type="button" data-icon="üéÆ" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üéÆ</button>
                                <button type="button" data-icon="üé¨" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üé¨</button>
                                <button type="button" data-icon="üì∫" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üì∫</button>
                                <button type="button" data-icon="üéß" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üéß</button>
                                <button type="button" data-icon="‚öîÔ∏è" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">‚öîÔ∏è</button>
                                <button type="button" data-icon="üèãÔ∏è" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üèãÔ∏è</button>
                                <button type="button" data-icon="üßò" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üßò</button>
                                <button type="button" data-icon="üéØ" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üéØ</button>
                                <button type="button" data-icon="üíº" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üíº</button>
                                <button type="button" data-icon="üõ°Ô∏è" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üõ°Ô∏è</button>
                                <button type="button" data-icon="üë•" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üë•</button>
                                <button type="button" data-icon="üßπ" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üßπ</button>
                                <button type="button" data-icon="üß†" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üß†</button>
                                <button type="button" data-icon="üç≥" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">üç≥</button>
                                <button type="button" data-icon="‚úçÔ∏è" class="icon-btn w-8 h-8 flex items-center justify-center bg-dark-300 hover:bg-accent/20 rounded transition-colors">‚úçÔ∏è</button>
                            </div>
                            <input type="hidden" id="selected-icon" value="üìö">
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-2">
                            <button type="button" id="cancel-duty" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors">
                                Cancel
                            </button>
                            <button type="submit" id="save-duty" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors">
                                Inscribe Duty
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Duty List -->
                <div id="duty-list-container" class="lg:col-span-2 bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl gothic font-semibold">Sacred Duties</h3>
                        
                        <div class="flex">
                            <button id="select-all-btn" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-3 py-1 rounded text-sm mr-2 transition-colors">
                                <i class="fas fa-check-square mr-1"></i> Select All
                            </button>
                            <button id="delete-selected-btn" disabled class="bg-red-900/40 hover:bg-red-800/60 text-accent/50 cursor-not-allowed border border-red-900/30 px-3 py-1 rounded text-sm transition-colors">
                                <i class="fas fa-trash mr-1"></i> Purge Selected
                            </button>
                        </div>
                    </div>
                    
                    <div id="duty-list" class="activity-list-container">
                        <div id="empty-duty-list" class="text-center py-12">
                            <i class="fas fa-book text-4xl text-accent/20 mb-3"></i>
                            <p class="text-accent/50">No duties inscribed yet</p>
                            <p class="text-accent/30 text-sm mt-1">Click "Add New Duty" to begin your service</p>
                        </div>
                        
                        <!-- Duties will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tactical Slate Tab -->
        <div id="tactical-tab" class="tab-content">
            <h2 class="text-2xl gothic font-semibold mb-6">Tactical Slate</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Total Missions Completed</h3>
                    <div class="flex items-end">
                        <span id="total-missions" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">missions</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Mission Assignments</h3>
                    <div class="flex items-end">
                        <span id="generation-count" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">received</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Longest Service Streak</h3>
                    <div class="flex items-end">
                        <span id="highest-streak" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">days</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Glory Points</h3>
                    <div class="flex items-end">
                        <span id="glory-points" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">earned</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Corruption Level</h3>
                    <div class="flex items-end">
                        <span id="corruption-level" class="text-4xl font-bold text-red-500">0</span>
                        <span class="text-accent/50 ml-2 mb-1">/ 15</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Paragon Rank</h3>
                    <div class="flex items-end">
                        <span id="paragon-rank" class="text-4xl font-bold text-imperial">0</span>
                        <span class="text-accent/50 ml-2 mb-1">level</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Total Artifacts Found</h3>
                    <div class="flex items-end">
                        <span id="total-artifacts-found" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">discovered</span>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-3">Total Artifacts Sold</h3>
                    <div class="flex items-end">
                        <span id="total-artifacts-sold" class="text-4xl font-bold text-accent">0</span>
                        <span class="text-accent/50 ml-2 mb-1">sold</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Completion by Type</h3>
                    <div id="type-stats" class="space-y-3">
                        <!-- Type stats will be dynamically added here -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <span class="text-2xl mr-2">üìö</span>
                                <span>Reading</span>
                            </div>
                            <span class="font-bold text-accent">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Faction Progress</h3>
                    <div id="faction-progress" class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span>Current Faction:</span>
                            <span id="current-faction" class="font-bold text-accent">Space Marines</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Rank:</span>
                            <span id="faction-rank" class="font-bold text-accent">Initiate</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Progress:</span>
                            <span id="rank-progress" class="font-bold text-accent">0 / 50</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Paragon Rank:</span>
                            <span id="paragon-progress" class="font-bold text-imperial">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Next Paragon:</span>
                            <span id="paragon-next" class="font-bold text-imperial">0 / 100 GP</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Missions Completed by Faction</h3>
                    <div id="faction-missions-stats" class="space-y-3">
                        <!-- Faction mission stats will be dynamically added here -->
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Glory Points Earned by Faction</h3>
                    <div id="faction-glory-stats" class="space-y-3">
                        <!-- Faction glory stats will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <h2 class="text-2xl gothic font-semibold mb-6">Imperial Command Settings</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Faction Allegiance</h3>
                    
                    <div class="mb-4">
                        <label for="faction-select" class="block text-sm text-accent/80 mb-2">Choose Your Allegiance:</label>
                        <div class="tooltip relative">
                            <select id="faction-select" class="w-full bg-dark-300 text-accent border border-accent/50 rounded py-2 px-3 text-base cursor-help">
                                <option value="space-marines">Space Marines - The Emperor's Finest</option>
                                <option value="chaos">Chaos - Embrace the Dark Gods</option>
                                <option value="orks">Orks - WAAAGH! and Mayhem</option>
                                <option value="eldar">Eldar - Ancient Wisdom</option>
                                <option value="imperial-guard">Imperial Guard - For the Emperor!</option>
                            </select>
                            <div class="tooltip-text above" id="faction-tooltip-settings">
                                <strong>Space Marines - The Emperor's Finest</strong><br>
                                ‚Ä¢ Favor high-priority tasks (Scale 4-5 get 50% selection boost)<br>
                                ‚Ä¢ Complete 3 missions in a row to gain "Zeal" (next mission costs -1 Resolve)<br>
                                ‚Ä¢ Stoic and disciplined approach to all duties
                            </div>
                        </div>
                    </div>
                    
                    <button id="change-faction" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors w-full">
                        <i class="fas fa-exchange-alt mr-2"></i> Pledge Allegiance
                    </button>
                    
                    <p class="text-xs text-accent/60 mt-2">Note: Changing faction resets rank but preserves Paragon progress</p>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Vox-Caster</h3>
                    
                    <button id="help-btn" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors w-full mb-4">
                        <i class="fas fa-question-circle mr-2"></i> Access Tutorial Archives
                    </button>
                    
                    <div id="tutorial-progress" class="text-sm text-accent/60">
                        <p>Tutorial Entries Unlocked: <span id="tutorial-count">1</span> / 7</p>
                    </div>
                </div>
                
                <div class="bg-dark-500 border border-accent/30 rounded-lg p-4 shadow-lg">
                    <h3 class="text-xl gothic font-semibold mb-4">Data Management</h3>
                    
                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <button id="save-game" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors">
                            <i class="fas fa-save mr-2"></i> Manual Save
                        </button>
                        
                        <button id="export-data" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors">
                            <i class="fas fa-file-export mr-2"></i> Export Data
                        </button>
                        
                        <button id="import-data" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors">
                            <i class="fas fa-file-import mr-2"></i> Import Data
                        </button>
                        
                        <button id="hard-reset" class="bg-red-900/40 hover:bg-red-800/60 text-accent/80 border border-red-900/30 px-4 py-2 rounded font-medium transition-colors">
                            <i class="fas fa-skull mr-2"></i> Purge All Data
                        </button>
                    </div>
                    
                    <div id="export-container" class="hidden mt-4">
                        <p class="text-accent/70 text-sm mb-2">Copy this sacred data code:</p>
                        <textarea id="export-text" class="w-full bg-dark-300 text-accent border border-accent/50 rounded p-2 text-sm" rows="4" readonly></textarea>
                    </div>
                    
                    <div id="import-container" class="hidden mt-4">
                        <p class="text-accent/70 text-sm mb-2">Paste sacred data code:</p>
                        <textarea id="import-text" class="w-full bg-dark-300 text-accent border border-accent/50 rounded p-2 text-sm" rows="4" placeholder="Paste exported data here..."></textarea>
                        <div class="flex justify-end mt-2">
                            <button id="confirm-import" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-3 py-1 rounded text-sm transition-colors">
                                Restore Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="mt-8 py-4 px-4 sm:px-6 border-t border-accent/30 bg-dark-400 text-accent/50 text-sm">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
            <div>
                <p>¬© 2025 Duty Eternal - By the Emperor's Will</p>
                <p>Developed by <a href="https://ko-fi.com/cygryu" target="_blank" class="text-accent hover:text-accent/80 transition-colors">CygRyu</a></p>
            </div>
            <div class="mt-2 md:mt-0 flex items-center space-x-4">
                <a href="https://ko-fi.com/cygryu" target="_blank" class="text-accent/60 hover:text-accent transition-colors">
                    <i class="fas fa-mug-hot mr-1"></i> Ko-Fi
                </a>
                <a href="https://www.paypal.com/paypalme/sofiansu?country.x=ID&locale.x=en_US" target="_blank" class="text-accent/60 hover:text-accent transition-colors">
                    <i class="fab fa-paypal mr-1"></i> PayPal
                </a>
            </div>
        </div>
    </footer>
    
    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl gothic font-bold mb-4 text-accent">Vox-Caster Archives</h2>
            
            <div id="tutorial-entries" class="space-y-4 mb-4">
                <!-- Tutorial entries will be populated here -->
            </div>
            
            <div class="flex justify-center">
                <button id="tutorial-close" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-6 py-2 rounded font-semibold transition-colors">
                    Close Archives
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl gothic font-bold mb-4 text-accent" id="confirm-title">Confirm Action</h2>
            <p id="confirm-message" class="mb-6">Are you sure you want to proceed?</p>
            
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-4 py-2 rounded font-medium transition-colors">
                    Cancel
                </button>
                <button id="confirm-ok" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Artifact Selection Modal -->
    <div id="artifact-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-xl gothic font-bold mb-4 text-accent" id="artifact-modal-title">Storage Full!</h2>
            <p id="artifact-modal-message" class="mb-4">Your artifact storage is full. Replace an existing artifact or discard the new one?</p>
            
            <div id="artifact-selection-grid" class="artifact-grid mb-4">
                <!-- Artifact selection will be populated here -->
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="artifact-discard" class="bg-red-900/40 hover:bg-red-800/60 text-accent/80 border border-red-900/30 px-4 py-2 rounded font-medium transition-colors">
                    Discard New
                </button>
                <button id="artifact-replace" class="bg-accent hover:bg-accent/80 text-dark border border-accent/50 px-4 py-2 rounded font-semibold transition-colors" disabled>
                    Replace Selected
                </button>
            </div>
        </div>
    </div>

    <script>
        /////////////////////////////////////////////
        // Main application class - Duty Eternal
        /////////////////////////////////////////////
        class DutyEternal {
            constructor() {
                // Core data storage
                this.duties = [];
                this.missions = [];
                this.nextId = 1;
                
                // Game state
                this.gameState = {
                    // Basic progression
                    totalMissionsCompleted: 0,
                    generationCount: 0,
                    highestStreak: 0,
                    typeCompletions: {},
                    lastDayCompleted: null,
                    currentStreak: 0,
                    completedToday: 0,
                    lastReset: new Date().toDateString(),
                    
                    // Warhammer 40K specific
                    faction: 'space-marines',
                    rank: 'Initiate',
                    gloryPoints: 0,
                    paragonRank: 0,
                    corruption: 0,
                    tutorialProgress: 1,
                    
                    // Resolve system (Stamina equivalent)
                    resolve: 5,
                    maxResolve: 5,
                    lastResolveRegeneration: Date.now(),
                    isCorrupted: false,
                    corruptionQuests: 0,
                    missionsDeletionCount: 0,
                    
                    // Artifacts system
                    artifacts: [],
                    equippedArtifacts: [],
                    totalArtifactsFound: 0,
                    totalArtifactsSold: 0,
                    
                    // Faction-specific tracking
                    factionMissionsCompleted: {
                        'space-marines': 0,
                        'chaos': 0,
                        'orks': 0,
                        'eldar': 0,
                        'imperial-guard': 0
                    },
                    factionGloryEarned: {
                        'space-marines': 0,
                        'chaos': 0,
                        'orks': 0,
                        'eldar': 0,
                        'imperial-guard': 0
                    },
                    
                    // Faction-specific buffs and progress
                    factionBuffs: {
                        zealStacks: 0,
                        dutyStacks: 0,
                        lastMissionTime: null,
                        consecutiveMissions: 0,
                        zealDuration: 0,
                        waaaghUsedToday: false,
                        lastDayReset: new Date().toDateString()
                    },
                    
                    // Rank progression system
                    rankRequirements: {},
                    rankBenefits: {},
                    paragonBenefits: {
                        maxResolve: 0,
                        gloryMultiplier: 0,
                        corruptionResistance: 0,
                        artifactSlots: 0
                    },
                    
                    // Faction switching tracking
                    hereticalBenefits: {},
                    redemptionProgress: 0
                };
                
                // Artifact replacement tracking
                this.pendingArtifact = null;
                this.selectedArtifactIndex = -1;
                
                // Rank requirements for each faction rank (DOUBLED FROM ORIGINAL)
                this.rankThresholds = {
                    2: { min: 90, max: 110 },
                    3: { min: 180, max: 220 },
                    4: { min: 270, max: 330 },
                    5: { min: 360, max: 440 }
                };
                
                // Faction rank names
                this.factionRanks = {
                    'space-marines': ['Initiate', 'Battle-Brother', 'Veteran', 'Sergeant', 'Captain'],
                    'chaos': ['Cultist', 'Chaos Marine', 'Chosen', 'Aspiring Champion', 'Chaos Lord'],
                    'orks': ['Gretchin', 'Boy', 'Nob', 'Big Boss', 'Warboss'],
                    'eldar': ['Guardian', 'Aspect Warrior', 'Exarch', 'Autarch', 'Phoenix Lord'],
                    'imperial-guard': ['Conscript', 'Guardsman', 'Veteran', 'Sergeant', 'Commissar']
                };
                
                // Expanded mission flavor text templates (100+ templates)
                this.missionTemplates = {
                    'space-marines': [
                        'Purge the Heretic stronghold', 'Defend the sacred shrine', 'Crush the Xenos threat', 'Honor the Chapter traditions',
                        'Cleanse the tainted sector', 'Strike with righteous fury', 'Protect the innocent', 'Uphold the Codex Astartes',
                        'Eliminate the traitor forces', 'Secure the holy relic', 'Destroy the enemy fortress', 'Execute the Emperor\'s will',
                        'Banish the daemon prince', 'Reclaim the lost world', 'Annihilate the chaos spawn', 'Sanctify the battleground',
                        'Guard the gene-seed vault', 'Hunt the fallen angel', 'Retrieve the sacred banner', 'Storm the citadel walls',
                        'Obliterate the warp gate', 'Silence the psyker cult', 'Fortify the monastery', 'Advance the Imperial truth',
                        'Terminate the xenos infestation', 'Consecrate the battlefield', 'Shield the pilgrims', 'Pierce the enemy lines'
                    ],
                    'chaos': [
                        'Corrupt the Imperial bastion', 'Embrace the Warp\'s chaos', 'Slay for the Blood God', 'Spread the Dark Gods\' influence',
                        'Destroy the False Emperor\'s servants', 'Unleash daemonic power', 'Burn the loyalist stronghold', 'Ascend through carnage',
                        'Sacrifice the innocent souls', 'Invoke the daemon\'s name', 'Defile the sacred temple', 'Harvest mortal terror',
                        'Summon the warp storm', 'Corrupt the gene-seed', 'Break the loyalist will', 'Feed the Dark Gods',
                        'Desecrate the shrine', 'Unleash plague and pestilence', 'Twist reality\'s fabric', 'Claim souls for Chaos',
                        'Burn the Imperial records', 'Corrupt the tech-priest', 'Breach the gellar field', 'Manifest the daemon host',
                        'Shatter the Emperor\'s light', 'Spread madness and mutation', 'Breach the convent walls', 'Overthrow the planetary governor'
                    ],
                    'orks': [
                        'WAAAGH! against da humies', 'Krump da git boss', 'Loot da shiny bits', 'Start a propa fight',
                        'Show \'em who\'s biggest', 'Smash da puny runts', 'Get more dakka', 'Paint it red for speed',
                        'Stomp da squishy gits', 'Find da biggest gun', 'Bash da weedy boyz', 'Make more noise',
                        'Grab da best loot', 'Chomp da enemy boss', 'Build da biggest mek', 'Race da fastest trukk',
                        'Squash da little \'uns', 'Krump everything green', 'Find da loudest shoota', 'Smash da shiny fings',
                        'Hunt da biggest squig', 'Break da enemy\'s teef', 'Loot da flashy gubbinz', 'Start da biggest brawl',
                        'Stomp on da weak gits', 'Find da best scrap', 'Make da loudest boom', 'Krump da weird boyz'
                    ],
                    'eldar': [
                        'Navigate the Webway\'s path', 'Preserve ancient knowledge', 'Thwart She Who Thirsts', 'Guide fate\'s threads',
                        'Protect the Craftworld', 'Unravel Mon-keigh plans', 'Commune with the spirits', 'Dance the war\'s edge',
                        'Weave the skeins of destiny', 'Safeguard the infinity circuit', 'Outwit the crude Mon-keigh', 'Foresee the coming darkness',
                        'Preserve the spirit stones', 'Navigate temporal currents', 'Protect the maiden world', 'Elude the great devourer',
                        'Manipulate the timeline', 'Secure the wraithbone cache', 'Guide the Phoenix Lord', 'Prevent the dark future',
                        'Shield from Chaos taint', 'Recover the lost lexicon', 'Commune with the dead', 'Dance between the raindrops',
                        'Outmaneuver the crude Imperium', 'Preserve the dying race', 'Navigate the crystal maze', 'Channel the psychic winds'
                    ],
                    'imperial-guard': [
                        'Hold the line at all costs', 'Execute Order 227', 'For the Emperor and Cadia', 'Advance under artillery cover',
                        'Defend the trench network', 'Break the enemy siege', 'Support the Astartes assault', 'Die with honor for the Imperium',
                        'Fix bayonets and charge', 'Man the fortress walls', 'Deploy the heavy weapons', 'Execute the traitors',
                        'Establish forward positions', 'Call in orbital bombardment', 'Secure the supply lines', 'Weather the enemy storm',
                        'March into the meat grinder', 'Stand firm against the tide', 'Follow the commissar\'s orders', 'Guard the ammunition depot',
                        'Advance through no man\'s land', 'Hold until reinforcements arrive', 'Execute tactical withdrawal', 'Sacrifice for the greater good',
                        'Maintain discipline in ranks', 'Endure the endless war', 'Serve the God-Emperor faithfully', 'Fight to the last man'
                    ]
                };
                
                // Universal mission templates that work with any activity type
                this.universalTemplates = [
                    'Destroy the Enemy General\'s Lair', 'Secure the Hive Spire', 'Infiltrate the Fortress Monastery', 'Eliminate the Xenos Leader',
                    'Retrieve the Sacred Artifact', 'Defend the Strategic Outpost', 'Purge the Corruption Source', 'Breach the Enemy Stronghold',
                    'Investigate the Distress Signal', 'Escort the Imperial Convoy', 'Sabotage the Enemy Communications', 'Establish Forward Base',
                    'Hunt the Rogue Psyker', 'Locate the Missing Squad', 'Destroy the Weapon Cache', 'Secure the Landing Zone',
                    'Assassinate the Cult Leader', 'Retrieve Lost Intelligence', 'Defend the Evacuation Point', 'Storm the Command Center',
                    'Disrupt Enemy Supply Lines', 'Rescue Captured Allies', 'Plant Demolition Charges', 'Gather Battlefield Intel',
                    'Establish Communication Link', 'Neutralize Heavy Weapons', 'Extract High-Value Target', 'Clear the Mine Field',
                    'Silence the Enemy Artillery', 'Secure the Bridge Crossing', 'Recover the Black Box', 'Eliminate Sniper Threat',
                    'Fortify Defensive Positions', 'Conduct Reconnaissance Mission', 'Jam Enemy Transmissions', 'Protect the Tech-Priest',
                    'Cleanse the Daemon Incursion', 'Survive the Night Assault', 'Break the Enemy Encirclement', 'Activate the Beacon',
                    'Hold the Sacred Ground', 'Pierce the Void Shields', 'Recover the Gene-Seed', 'Destroy the Heretic Shrine',
                    'Establish Overwatch Position', 'Conduct Search and Destroy', 'Secure the Extraction Point', 'Prevent Enemy Escape'
                ];
                
                // Faction descriptions for tooltips
                this.factionDescriptions = {
                    'space-marines': {
                        name: 'Space Marines - The Emperor\'s Finest',
                        description: '‚Ä¢ Favor high-priority tasks (Scale 4-5 get 50% selection boost)\n‚Ä¢ Complete 3 missions in a row to gain "Zeal" (next mission costs -1 Resolve)\n‚Ä¢ Stoic and disciplined approach to all duties'
                    },
                    'chaos': {
                        name: 'Chaos - Embrace the Dark Gods',
                        description: '‚Ä¢ 10% chance for "Warp Temptation" (bonus Glory Points, +1 Corruption risk)\n‚Ä¢ Randomizes task selection for unpredictable missions\n‚Ä¢ Brutal and destructive approach to objectives'
                    },
                    'orks': {
                        name: 'Orks - WAAAGH! and Mayhem',
                        description: '‚Ä¢ 20% chance for "WAAAGH!" event (adds random high-reward mission)\n‚Ä¢ Low-priority tasks are more likely to be selected\n‚Ä¢ Crude and violent approach with chaotic energy'
                    },
                    'eldar': {
                        name: 'Eldar - Ancient Wisdom',
                        description: '‚Ä¢ High-priority missions have 15% Resolve refund if completed within 4 hours\n‚Ä¢ Failing high-priority missions adds +2 Corruption\n‚Ä¢ Precise and calculated approach to all tasks'
                    },
                    'imperial-guard': {
                        name: 'Imperial Guard - For the Emperor!',
                        description: '‚Ä¢ Low-priority tasks (Scale 1-2) grant stacking "Duty" buff\n‚Ä¢ +5% Glory Points per completed low-priority task (max 25%)\n‚Ä¢ Steadfast and determined approach through perseverance'
                    }
                };
                
                // UI elements
                this.elements = {
                    // Mission Board
                    missionContainer: document.getElementById('mission-container'),
                    emptyMissionPrompt: document.getElementById('empty-mission-prompt'),
                    missionCount: document.getElementById('mission-count'),
                    generateMissions: document.getElementById('generate-missions'),
                    missionWarning: document.getElementById('mission-warning'),
                    warningMessage: document.getElementById('warning-message'),
                    corruptionWarning: document.getElementById('corruption-warning'),
                    waaaghButton: document.getElementById('waaagh-button'),
                    waaaghButtonContainer: document.getElementById('waaagh-button-container'),
                    diminishingReturnsWarning: document.getElementById('diminishing-returns-warning'),
                    diminishingMessage: document.getElementById('diminishing-message'),
                    
                    // Resolve display
                    resolveDisplay: document.getElementById('resolve-display'),
                    resolveInfo: document.getElementById('resolve-info'),
                    resolveTimer: document.getElementById('resolve-timer'),
                    
                    // Progress tracking
                    missionsCompletedToday: document.getElementById('missions-completed-today'),
                    dailyProgressBar: document.getElementById('daily-progress-bar'),
                    
                    // Faction display
                    factionDisplay: document.getElementById('faction-display'),
                    factionBuffsDisplay: document.getElementById('faction-buffs-display'),
                    currentRank: document.getElementById('current-rank'),
                    paragonDisplay: document.getElementById('paragon-display'),
                    rankProgressFill: document.getElementById('rank-progress-fill'),
                    factionTooltipHeader: document.getElementById('faction-tooltip-header'),
                    factionTooltipSettings: document.getElementById('faction-tooltip-settings'),
                    
                    // Archives (Activities)
                    dutyList: document.getElementById('duty-list'),
                    emptyDutyList: document.getElementById('empty-duty-list'),
                    dutyForm: document.getElementById('duty-form'),
                    dutyFormContainer: document.getElementById('duty-form-container'),
                    addDutyBtn: document.getElementById('add-duty-btn'),
                    emptyAddDutyBtn: document.getElementById('empty-add-duty-btn'),
                    cancelDuty: document.getElementById('cancel-duty'),
                    
                    // Form elements
                    dutyTypeSelect: document.getElementById('duty-type'),
                    customType: document.getElementById('custom-type'),
                    dutyObjectSelect: document.getElementById('duty-object'),
                    customObject: document.getElementById('custom-object'),
                    dutyUnitSelect: document.getElementById('duty-unit'),
                    customUnit: document.getElementById('custom-unit'),
                    dutyTargetType: document.getElementById('duty-target-type'),
                    dutyTargetMin: document.getElementById('duty-target-min'),
                    dutyTargetMax: document.getElementById('duty-target-max'),
                    dutyPriority: document.getElementById('duty-priority'),
                    priorityValue: document.getElementById('priority-value'),
                    iconButtons: document.querySelectorAll('.icon-btn'),
                    selectedIcon: document.getElementById('selected-icon'),
                    
                    // Bulk operations
                    selectAllBtn: document.getElementById('select-all-btn'),
                    deleteSelectedBtn: document.getElementById('delete-selected-btn'),
                    
                    // Stats
                    totalMissionsElement: document.getElementById('total-missions'),
                    generationCountElement: document.getElementById('generation-count'),
                    highestStreakElement: document.getElementById('highest-streak'),
                    gloryPointsElement: document.getElementById('glory-points'),
                    corruptionLevelElement: document.getElementById('corruption-level'),
                    paragonRankElement: document.getElementById('paragon-rank'),
                    typeStatsElement: document.getElementById('type-stats'),
                    currentFactionElement: document.getElementById('current-faction'),
                    factionRankElement: document.getElementById('faction-rank'),
                    rankProgressElement: document.getElementById('rank-progress'),
                    paragonProgressElement: document.getElementById('paragon-progress'),
                    paragonNextElement: document.getElementById('paragon-next'),
                    totalArtifactsFoundElement: document.getElementById('total-artifacts-found'),
                    totalArtifactsSoldElement: document.getElementById('total-artifacts-sold'),
                    factionMissionsStatsElement: document.getElementById('faction-missions-stats'),
                    factionGloryStatsElement: document.getElementById('faction-glory-stats'),
                    
                    // Armory
                    rankBenefitsElement: document.getElementById('rank-benefits'),
                    paragonBenefitsElement: document.getElementById('paragon-benefits'),
                    artifactsContainer: document.getElementById('artifacts-container'),
                    artifactStorageCount: document.getElementById('artifact-storage-count'),
                    artifactEquippedCount: document.getElementById('artifact-equipped-count'),
                    artifactMaxEquipped: document.getElementById('artifact-max-equipped'),
                    
                    // Settings
                    factionSelect: document.getElementById('faction-select'),
                    changeFaction: document.getElementById('change-faction'),
                    saveGame: document.getElementById('save-game'),
                    exportData: document.getElementById('export-data'),
                    importData: document.getElementById('import-data'),
                    exportContainer: document.getElementById('export-container'),
                    importContainer: document.getElementById('import-container'),
                    exportText: document.getElementById('export-text'),
                    importText: document.getElementById('import-text'),
                    confirmImport: document.getElementById('confirm-import'),
                    hardReset: document.getElementById('hard-reset'),
                    
                    // Tutorial
                    helpBtn: document.getElementById('help-btn'),
                    tutorialModal: document.getElementById('tutorial-modal'),
                    tutorialClose: document.getElementById('tutorial-close'),
                    tutorialEntries: document.getElementById('tutorial-entries'),
                    tutorialCount: document.getElementById('tutorial-count'),
                    
                    // Navigation and modals
                    tabButtons: document.querySelectorAll('.tab-btn'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    confirmModal: document.getElementById('confirm-modal'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmMessage: document.getElementById('confirm-message'),
                    confirmOk: document.getElementById('confirm-ok'),
                    confirmCancel: document.getElementById('confirm-cancel'),
                    
                    // Artifact modal
                    artifactModal: document.getElementById('artifact-modal'),
                    artifactModalTitle: document.getElementById('artifact-modal-title'),
                    artifactModalMessage: document.getElementById('artifact-modal-message'),
                    artifactSelectionGrid: document.getElementById('artifact-selection-grid'),
                    artifactDiscard: document.getElementById('artifact-discard'),
                    artifactReplace: document.getElementById('artifact-replace'),
                    
                    // Toast system
                    toastContainer: document.getElementById('toast-container')
                };
                
                // Initialize
                this.init();
            }
            
            init() {
                // Load saved data
                this.loadFromStorage();
                
                // Check for day change
                this.checkDayChange();
                
                // Initialize rank requirements if not set
                this.initializeRankRequirements();
                
                // Set up event listeners
                this.setupEventListeners();
                
                // Render UI
                this.updateResolveDisplay();
                this.updateMissionBoard();
                this.updateDutyList();
                this.updateStats();
                this.updateFactionDisplay();
                this.updateTutorialProgress();
                this.updateRankBenefits();
                this.updateParagonBenefits();
                this.updateArtifactsDisplay();
                this.updateDiminishingReturnsWarning();
                
                // Start resolve regeneration timer
                this.startResolveRegeneration();
                
                // Set up form validation
                this.setupFormValidation();
            }
            
            initializeRankRequirements() {
                const currentFaction = this.gameState.faction;
                
                if (!this.gameState.rankRequirements[currentFaction]) {
                    this.gameState.rankRequirements[currentFaction] = {};
                    
                    // Generate randomized requirements for ranks 2-5 (doubled)
                    for (let rank = 2; rank <= 5; rank++) {
                        const threshold = this.rankThresholds[rank];
                        this.gameState.rankRequirements[currentFaction][rank] = 
                            Math.floor(Math.random() * (threshold.max - threshold.min + 1)) + threshold.min;
                    }
                    
                    this.saveToStorage();
                }
            }
            
            setupEventListeners() {
                // Tab navigation
                this.elements.tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.elements.tabButtons.forEach(btn => {
                            btn.classList.remove('active', 'border-accent');
                            btn.classList.add('border-transparent');
                        });
                        
                        button.classList.add('active', 'border-accent');
                        button.classList.remove('border-transparent');
                        
                        const tab = button.getAttribute('data-tab');
                        this.elements.tabContents.forEach(content => content.classList.remove('active'));
                        document.getElementById(`${tab}-tab`).classList.add('active');
                    });
                });
                
                // WAAAGH! button
                this.elements.waaaghButton.addEventListener('click', () => this.triggerWaaaghEvent());
                
                // Duty form related
                this.elements.addDutyBtn.addEventListener('click', () => this.showDutyForm());
                this.elements.emptyAddDutyBtn.addEventListener('click', () => {
                    this.switchToTab('archives');
                    this.showDutyForm();
                });
                this.elements.cancelDuty.addEventListener('click', () => this.hideDutyForm());
                this.elements.dutyForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveDuty();
                });
                
                // Custom dropdowns
                this.elements.dutyTypeSelect.addEventListener('change', () => {
                    if (this.elements.dutyTypeSelect.value === 'custom') {
                        this.elements.customType.classList.remove('hidden');
                    } else {
                        this.elements.customType.classList.add('hidden');
                    }
                });
                
                this.elements.dutyObjectSelect.addEventListener('change', () => {
                    if (this.elements.dutyObjectSelect.value === 'custom') {
                        this.elements.customObject.classList.remove('hidden');
                    } else {
                        this.elements.customObject.classList.add('hidden');
                    }
                });
                
                this.elements.dutyUnitSelect.addEventListener('change', () => {
                    if (this.elements.dutyUnitSelect.value === 'custom') {
                        this.elements.customUnit.classList.remove('hidden');
                    } else {
                        this.elements.customUnit.classList.add('hidden');
                    }
                });
                
                // Target type change
                this.elements.dutyTargetType.addEventListener('change', () => {
                    if (this.elements.dutyTargetType.value === 'range') {
                        this.elements.dutyTargetMax.removeAttribute('disabled');
                    } else {
                        this.elements.dutyTargetMax.setAttribute('disabled', 'disabled');
                    }
                });
                
                // Priority display
                this.elements.dutyPriority.addEventListener('input', () => {
                    this.elements.priorityValue.textContent = this.elements.dutyPriority.value;
                });
                
                // Icon selection
                this.elements.iconButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        this.elements.iconButtons.forEach(btn => btn.classList.remove('bg-accent/40'));
                        button.classList.add('bg-accent/40');
                        this.elements.selectedIcon.value = button.getAttribute('data-icon');
                    });
                });
                
                // Generate missions
                this.elements.generateMissions.addEventListener('click', () => this.generateMissions());
                
                // Bulk operations
                this.elements.selectAllBtn.addEventListener('click', () => this.toggleSelectAll());
                this.elements.deleteSelectedBtn.addEventListener('click', () => this.showDeleteSelectedConfirmation());
                
                // Settings
                this.elements.changeFaction.addEventListener('click', () => this.changeFaction());
                this.elements.saveGame.addEventListener('click', () => this.manualSave());
                this.elements.exportData.addEventListener('click', () => this.exportGameData());
                this.elements.importData.addEventListener('click', () => this.showImportData());
                this.elements.confirmImport.addEventListener('click', () => this.importGameData());
                this.elements.hardReset.addEventListener('click', () => this.showHardResetConfirmation());
                
                // Faction select tooltip
                this.elements.factionSelect.addEventListener('change', () => this.updateFactionTooltip());
                
                // Tutorial
                this.elements.helpBtn.addEventListener('click', () => {
                    this.elements.tutorialModal.classList.remove('hidden');
                });
                this.elements.tutorialClose.addEventListener('click', () => {
                    this.elements.tutorialModal.classList.add('hidden');
                });
                
                // Confirmation dialog
                this.elements.confirmCancel.addEventListener('click', () => {
                    this.elements.confirmModal.classList.add('hidden');
                });
                
                // Artifact modal
                this.elements.artifactDiscard.addEventListener('click', () => {
                    this.discardPendingArtifact();
                });
                this.elements.artifactReplace.addEventListener('click', () => {
                    this.replacePendingArtifact();
                });
            }
            
            switchToTab(tabName) {
                this.elements.tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-accent');
                    btn.classList.add('border-transparent');
                });
                
                const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
                if (targetButton) {
                    targetButton.classList.add('active', 'border-accent');
                    targetButton.classList.remove('border-transparent');
                }
                
                this.elements.tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }
            
            setupFormValidation() {
                const dutyName = document.getElementById('duty-name');
                const saveButton = document.getElementById('save-duty');
                
                const validateForm = () => {
                    if (dutyName.value.trim()) {
                        saveButton.removeAttribute('disabled');
                        saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        saveButton.setAttribute('disabled', 'disabled');
                        saveButton.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                };
                
                dutyName.addEventListener('input', validateForm);
                validateForm();
            }
            
            startResolveRegeneration() {
                setInterval(() => {
                    this.processResolveRegeneration();
                }, 60000); // Check every minute
                
                this.processResolveRegeneration();
            }
            
            processResolveRegeneration() {
                if (this.gameState.resolve >= this.gameState.maxResolve) {
                    this.elements.resolveTimer.textContent = '';
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastRegen = now - this.gameState.lastResolveRegeneration;
                
                // Apply rank 3 universal benefit: reduced regeneration time
                const hasRank3Benefit = this.getCurrentRankNumber() >= 3;
                const regenTime = hasRank3Benefit ? 25 * 60 * 1000 : 30 * 60 * 1000; // 25 or 30 minutes
                
                if (timeSinceLastRegen >= regenTime) {
                    const pointsToRegenerate = Math.floor(timeSinceLastRegen / regenTime);
                    this.gameState.resolve = Math.min(this.gameState.maxResolve, this.gameState.resolve + pointsToRegenerate);
                    this.gameState.lastResolveRegeneration += pointsToRegenerate * regenTime;
                    
                    this.updateResolveDisplay();
                    this.saveToStorage();
                }
                
                this.updateResolveTimer();
            }
            
            updateResolveTimer() {
                if (this.gameState.resolve >= this.gameState.maxResolve) {
                    this.elements.resolveTimer.textContent = '';
                    return;
                }
                
                const now = Date.now();
                const timeSinceLastRegen = now - this.gameState.lastResolveRegeneration;
                
                // Apply rank 3 universal benefit
                const hasRank3Benefit = this.getCurrentRankNumber() >= 3;
                const regenTime = hasRank3Benefit ? 25 * 60 * 1000 : 30 * 60 * 1000;
                const timeUntilNextRegen = regenTime - (timeSinceLastRegen % regenTime);
                
                const minutesLeft = Math.floor(timeUntilNextRegen / (60 * 1000));
                const secondsLeft = Math.floor((timeUntilNextRegen % (60 * 1000)) / 1000);
                
                this.elements.resolveTimer.textContent = `(+1 in ${minutesLeft}:${secondsLeft.toString().padStart(2, '0')})`;
            }
            
            // Calculate diminishing returns multiplier based on daily completions
            getDiminishingReturnsMultiplier() {
                const completedToday = this.gameState.completedToday;
                
                if (completedToday >= 20) {
                    return 0.25; // 25% for 20+ completions
                } else if (completedToday >= 10) {
                    return 0.5; // 50% for 10-19 completions
                } else if (completedToday >= 5) {
                    return 0.75; // 75% for 5-9 completions
                } else {
                    return 1.0; // 100% for 0-4 completions
                }
            }
            
            // Update the diminishing returns warning display
            updateDiminishingReturnsWarning() {
                const completedToday = this.gameState.completedToday;
                const multiplier = this.getDiminishingReturnsMultiplier();
                
                if (multiplier < 1.0) {
                    const percentage = Math.floor(multiplier * 100);
                    this.elements.diminishingMessage.textContent = 
                        `Diminishing returns active: Rewards reduced to ${percentage}% (${completedToday} missions completed today)`;
                    this.elements.diminishingReturnsWarning.classList.remove('hidden');
                } else {
                    this.elements.diminishingReturnsWarning.classList.add('hidden');
                }
            }
            
            triggerWaaaghEvent() {
                if (this.gameState.resolve < 2) {
                    this.showWarning('Insufficient resolve for WAAAGH!');
                    return;
                }
                
                if (this.gameState.factionBuffs.waaaghUsedToday) {
                    this.showWarning('WAAAGH! already used today!');
                    return;
                }
                
                if (this.duties.length === 0) {
                    this.showWarning('No duties available for WAAAGH!');
                    return;
                }
                
                this.gameState.resolve -= 2;
                this.gameState.factionBuffs.waaaghUsedToday = true;
                
                const randomDuty = this.duties[Math.floor(Math.random() * this.duties.length)];
                let target = randomDuty.targetType === 'at-least' ? randomDuty.targetMin * 2 : randomDuty.targetMax * 2;
                
                const waaaghMission = {
                    id: Date.now() + 9999,
                    dutyId: randomDuty.id,
                    target,
                    isNew: true,
                    isSpecial: true,
                    specialType: 'waaagh',
                    flavorText: `WAAAGH! SPECIAL: ${this.generateMissionFlavorText(randomDuty, target)} (DOUBLE REWARDS!)`
                };
                
                this.missions.push(waaaghMission);
                this.saveToStorage();
                this.updateMissionBoard();
                this.updateResolveDisplay();
                this.updateWaaaghButton();
                
                this.showToast('WAAAGH! Manually triggered! A special high-energy mission has appeared!', 'success');
            }
            
            generateMissions() {
                if (this.duties.length === 0) {
                    this.showWarning('Inscribe duties in the Archives first, loyal servant!');
                    return;
                }
                
                // Generation is free - no resolve cost
                this.gameState.generationCount++;
                this.saveToStorage();
                
                const desiredCount = parseInt(this.elements.missionCount.value);
                const currentMissionCount = this.missions.length;
                const emptySlots = Math.max(0, desiredCount - currentMissionCount);
                
                if (emptySlots <= 0) {
                    this.showWarning('The mission board is full! Complete missions to make room for new ones.');
                    return;
                }
                
                if (this.duties.length < emptySlots) {
                    this.elements.warningMessage.textContent = 
                        `Only ${this.duties.length} duties available; duplicates may occur.`;
                    this.elements.missionWarning.classList.remove('hidden');
                    
                    setTimeout(() => {
                        this.elements.missionWarning.classList.add('hidden');
                    }, 5000);
                }
                
                const newMissions = this.selectRandomDuties(emptySlots);
                this.missions = [...this.missions, ...newMissions];
                
                // Apply faction-specific generation effects
                this.applyFactionGenerationEffects();
                
                this.saveToStorage();
                this.updateMissionBoard();
                this.updateStats();
                
                this.elements.emptyMissionPrompt.classList.add('hidden');
            }
            
            applyFactionGenerationEffects() {
                // Orks: WAAAGH! event chance
                if (this.gameState.faction === 'orks') {
                    const currentRankNumber = this.getCurrentRankNumber();
                    let waaaghChance = 0.2; // Base 20%
                    
                    // Boy rank increases chance to 25%
                    if (currentRankNumber >= 2) {
                        waaaghChance = 0.25;
                    }
                    
                    if (Math.random() < waaaghChance) {
                        const randomDuty = this.duties[Math.floor(Math.random() * this.duties.length)];
                        if (randomDuty) {
                            let target = randomDuty.targetType === 'at-least' ? randomDuty.targetMin * 2 : randomDuty.targetMax * 2;
                            
                            const waaaghMission = {
                                id: Date.now() + 9999,
                                dutyId: randomDuty.id,
                                target,
                                isNew: true,
                                isSpecial: true,
                                specialType: 'waaagh',
                                flavorText: `WAAAGH! SPECIAL: ${this.generateMissionFlavorText(randomDuty, target)} (DOUBLE REWARDS!)`
                            };
                            
                            this.missions.push(waaaghMission);
                            this.showToast('WAAAGH! A special high-energy mission has appeared!', 'success');
                        }
                    }
                }
            }
            
            selectRandomDuties(count) {
                const newMissions = [];
                const availableDuties = [...this.duties];
                const currentMissionIds = this.missions.map(mission => mission.dutyId);
                
                for (let i = 0; i < count; i++) {
                    if (availableDuties.length === 0) break;
                    
                    const weights = availableDuties.map(duty => {
                        let weight = duty.priority;
                        
                        // Apply faction-specific priority modifications
                        this.applyFactionSelectionBonuses(duty, weight);
                        
                        if (this.gameState.isCorrupted) {
                            weight = Math.min(3, weight);
                        }
                        
                        if (duty.lastCompleted) {
                            const now = new Date();
                            const completed = new Date(duty.lastCompleted);
                            const hoursSince = (now - completed) / (1000 * 60 * 60);
                            
                            if (hoursSince < 24) {
                                weight *= (0.5 + (hoursSince / 48));
                            }
                        }
                        
                        if (currentMissionIds.includes(duty.id)) {
                            weight *= 0.2;
                        }
                        
                        return weight;
                    });
                    
                    const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                    let random = Math.random() * totalWeight;
                    let selectedIndex = -1;
                    
                    for (let j = 0; j < weights.length; j++) {
                        random -= weights[j];
                        if (random <= 0) {
                            selectedIndex = j;
                            break;
                        }
                    }
                    
                    if (selectedIndex === -1) selectedIndex = 0;
                    
                    const duty = availableDuties[selectedIndex];
                    availableDuties.splice(selectedIndex, 1);
                    
                    let target;
                    if (duty.targetType === 'at-least') {
                        target = duty.targetMin;
                    } else {
                        target = Math.floor(Math.random() * (duty.targetMax - duty.targetMin + 1)) + duty.targetMin;
                    }
                    
                    const mission = {
                        id: Date.now() + i,
                        dutyId: duty.id,
                        target,
                        isNew: true,
                        flavorText: this.generateMissionFlavorText(duty, target)
                    };
                    
                    newMissions.push(mission);
                }
                
                return newMissions;
            }
            
            applyFactionSelectionBonuses(duty, weight) {
                const currentRankNumber = this.getCurrentRankNumber();
                
                switch (this.gameState.faction) {
                    case 'space-marines':
                        if (duty.priority >= 4) {
                            weight *= 1.5; // Base 50% boost
                            // Veteran rank adds +25% more
                            if (currentRankNumber >= 3) {
                                weight *= 1.25;
                            }
                        }
                        break;
                        
                    case 'orks':
                        if (duty.priority <= 2) {
                            weight *= 1.4; // Favor low-priority
                        }
                        break;
                        
                    case 'imperial-guard':
                        if (duty.priority <= 2) {
                            weight *= 1.3; // Base favor for low-priority
                            // Veteran rank adds +20% more
                            if (currentRankNumber >= 3) {
                                weight *= 1.2;
                            }
                        }
                        break;
                        
                    case 'chaos':
                        // Chaos randomizes selection slightly
                        weight *= (0.8 + Math.random() * 0.4);
                        break;
                }
                
                return weight;
            }
            
            generateMissionFlavorText(duty, missionTarget) {
                const factionTemplates = this.missionTemplates[this.gameState.faction] || this.missionTemplates['space-marines'];
                const universalTemplates = this.universalTemplates;
                
                // Combine faction-specific and universal templates
                const allTemplates = [...factionTemplates, ...universalTemplates];
                
                // Weight by priority - higher priority gets more epic templates
                let templatePool = allTemplates;
                if (duty.priority >= 4) {
                    // High priority: favor the first half (more epic templates)
                    templatePool = allTemplates.slice(0, Math.floor(allTemplates.length * 0.7));
                } else if (duty.priority <= 2) {
                    // Low priority: favor the latter half (simpler templates)
                    templatePool = allTemplates.slice(Math.floor(allTemplates.length * 0.3));
                }
                
                const template = templatePool[Math.floor(Math.random() * templatePool.length)];
                
                return `${template} (${duty.type} ${duty.object}, ${missionTarget} ${duty.unit} of ${duty.name})`;
            }
            
            completeMission(missionId) {
                const missionIndex = this.missions.findIndex(m => m.id === missionId);
                if (missionIndex === -1) return;
                
                const mission = this.missions[missionIndex];
                const duty = this.duties.find(d => d.id === mission.dutyId);
                if (!duty) return;
                
                // Check faction-specific conditions before completion
                if (this.gameState.faction === 'eldar' && duty.priority >= 4) {
                    const missionStartTime = this.gameState.factionBuffs.lastMissionTime || Date.now();
                    const timeDiff = Date.now() - missionStartTime;
                    
                    // Autarch rank extends time window to 6 hours, base is 4 hours
                    const currentRankNumber = this.getCurrentRankNumber();
                    const timeWindow = (currentRankNumber >= 4) ? 6 * 60 * 60 * 1000 : 4 * 60 * 60 * 1000;
                    
                    if (timeDiff > timeWindow) {
                        // Phoenix Lord rank reduces corruption penalty
                        const corruptionPenalty = (currentRankNumber >= 5) ? 1 : 2;
                        this.gameState.corruption += corruptionPenalty;
                        this.showToast(`Failed to complete high-priority mission in time! +${corruptionPenalty} Corruption!`, 'error');
                    }
                }
                
                let resolveCost = this.getBaseMissionCost();
                
                // Apply faction-specific resolve modifications
                resolveCost = this.applyFactionResolveBonuses(resolveCost);
                
                const isFreeCompletion = Math.random() < 0.05;
                
                if (!isFreeCompletion && this.gameState.resolve < resolveCost) {
                    this.showWarning('Insufficient resolve! Wait for regeneration or purge your corruption.');
                    return;
                }
                
                // Update duty's last completed timestamp
                duty.lastCompleted = new Date().toISOString();
                
                // Remove mission
                this.missions.splice(missionIndex, 1);
                
                // Update stats
                this.gameState.totalMissionsCompleted++;
                this.gameState.completedToday++;
                this.gameState.lastDayCompleted = new Date().toDateString();
                
                // Update faction-specific stats
                this.gameState.factionMissionsCompleted[this.gameState.faction]++;
                
                // Calculate glory points based on priority
                let gloryEarned = duty.priority;
                
                // Apply faction-specific mission completion effects
                this.applyFactionCompletionEffects(duty, mission, gloryEarned);
                
                // Apply rank-specific bonuses
                gloryEarned = this.applyRankGloryBonuses(gloryEarned);
                
                // Apply Paragon glory bonuses
                gloryEarned = Math.floor(gloryEarned * (1 + this.gameState.paragonBenefits.gloryMultiplier / 100));
                
                // Special mission bonuses
                if (mission.isSpecial && mission.specialType === 'waaagh') {
                    let waaaghMultiplier = 2;
                    
                    // Nob rank adds +1 extra Glory Point to WAAAGH! missions
                    if (this.gameState.faction === 'orks' && this.getCurrentRankNumber() >= 3) {
                        gloryEarned += 1;
                    }
                    
                    gloryEarned *= waaaghMultiplier;
                    this.showToast('WAAAGH! mission completed for double rewards!', 'success');
                }
                
                // Apply Imperial Guard duty buff
                if (this.gameState.faction === 'imperial-guard' && this.gameState.factionBuffs.dutyStacks > 0) {
                    const currentRankNumber = this.getCurrentRankNumber();
                    // Commissar rank increases max bonus from 25% to 35%
                    const maxBonus = (currentRankNumber >= 5) ? 0.35 : 0.25;
                    const bonusMultiplier = 1 + Math.min(this.gameState.factionBuffs.dutyStacks * 0.05, maxBonus);
                    gloryEarned = Math.floor(gloryEarned * bonusMultiplier);
                }
                
                // Apply diminishing returns for daily completions
                const diminishingMultiplier = this.getDiminishingReturnsMultiplier();
                gloryEarned = Math.floor(gloryEarned * diminishingMultiplier);
                
                this.gameState.gloryPoints += gloryEarned;
                
                // Update faction glory earned
                this.gameState.factionGloryEarned[this.gameState.faction] += gloryEarned;
                
                // Update type stats
                const type = duty.type;
                if (!this.gameState.typeCompletions[type]) {
                    this.gameState.typeCompletions[type] = 0;
                }
                this.gameState.typeCompletions[type]++;
                
                // Use resolve (if not free completion)
                if (!isFreeCompletion) {
                    this.gameState.resolve -= resolveCost;
                } else {
                    this.showFreeCompletionEffect();
                }
                
                // Update corruption counter if corrupted
                if (this.gameState.isCorrupted) {
                    this.gameState.corruptionQuests++;
                    if (this.gameState.corruptionQuests >= 3) {
                        this.gameState.isCorrupted = false;
                        this.gameState.corruptionQuests = 0;
                        this.elements.corruptionWarning.classList.add('hidden');
                    }
                }
                
                // Update consecutive missions counter
                this.gameState.factionBuffs.consecutiveMissions++;
                this.gameState.factionBuffs.lastMissionTime = Date.now();
                
                // Check for rank progression
                this.checkRankProgression();
                
                // Check tutorial progression
                this.checkTutorialProgression();
                
                // Random artifact chance
                const currentRankNumber = this.getCurrentRankNumber();
                let artifactChance = 0.1; // Base 10%
                
                // Rank 2 universal benefit: +10% artifact discovery chance
                if (currentRankNumber >= 2) {
                    artifactChance += 0.1;
                }
                
                if (Math.random() < artifactChance) {
                    this.grantRandomArtifact();
                }
                
                // Show completion toast with rewards
                this.showMissionCompletionToast(duty, gloryEarned, resolveCost, isFreeCompletion, diminishingMultiplier);
                
                // Check for Warboss mini-WAAAGH! trigger
                if (this.gameState.faction === 'orks' && this.getCurrentRankNumber() >= 5 && Math.random() < 0.1) {
                    this.triggerMiniWaaaghEvent();
                }
                
                this.saveToStorage();
                this.updateMissionBoard();
                this.updateResolveDisplay();
                this.updateStats();
                this.updateFactionDisplay();
                this.updateWaaaghButton();
                this.updateDiminishingReturnsWarning();
            }
            
            getBaseMissionCost() {
                let cost = this.gameState.isCorrupted ? 2 : 1;
                
                // Space Marines Sergeant rank: all missions cost -1 Resolve (minimum 1)
                if (this.gameState.faction === 'space-marines' && this.getCurrentRankNumber() >= 4) {
                    cost = Math.max(1, cost - 1);
                }
                
                return cost;
            }
            
            applyFactionResolveBonuses(baseCost) {
                let cost = baseCost;
                
                // Apply Space Marines Zeal buff
                if (this.gameState.faction === 'space-marines' && this.gameState.factionBuffs.zealStacks > 0) {
                    cost = Math.max(0, cost - 1);
                    this.gameState.factionBuffs.zealStacks--;
                    
                    // Battle-Brother rank: Zeal buff lasts +1 additional mission
                    if (this.getCurrentRankNumber() >= 2 && this.gameState.factionBuffs.zealDuration > 0) {
                        this.gameState.factionBuffs.zealDuration--;
                        this.gameState.factionBuffs.zealStacks++; // Restore the stack
                    }
                }
                
                return cost;
            }
            
            applyRankGloryBonuses(baseGlory) {
                let glory = baseGlory;
                
                // Space Marines Captain rank: +50% Glory Points from all missions
                if (this.gameState.faction === 'space-marines' && this.getCurrentRankNumber() >= 5) {
                    glory = Math.floor(glory * 1.5);
                }
                
                return glory;
            }
            
            applyFactionCompletionEffects(duty, mission, gloryEarned) {
                const currentRankNumber = this.getCurrentRankNumber();
                
                switch (this.gameState.faction) {
                    case 'space-marines':
                        // Check for Zeal buff (3 consecutive missions)
                        if (this.gameState.factionBuffs.consecutiveMissions >= 3) {
                            this.gameState.factionBuffs.zealStacks++;
                            this.gameState.factionBuffs.consecutiveMissions = 0;
                            
                            // Battle-Brother rank: Zeal buff lasts +1 additional mission
                            if (currentRankNumber >= 2) {
                                this.gameState.factionBuffs.zealDuration = 1;
                            }
                            
                            this.showToast('Zeal achieved! Next mission costs -1 Resolve!', 'success');
                        }
                        break;
                        
                    case 'chaos':
                        // Warp Temptation chance
                        let warpChance = 0.1; // Base 10%
                        
                        // Chaos Marine rank increases chance to 15%
                        if (currentRankNumber >= 2) {
                            warpChance = 0.15;
                        }
                        
                        if (Math.random() < warpChance) {
                            let bonusMultiplier = 0.5; // Base +50%
                            
                            // Aspiring Champion rank: +100% bonus instead of +50%
                            if (currentRankNumber >= 4) {
                                bonusMultiplier = 1.0;
                            }
                            
                            const bonusGlory = Math.floor(gloryEarned * bonusMultiplier);
                            this.gameState.gloryPoints += bonusGlory;
                            this.gameState.factionGloryEarned[this.gameState.faction] += bonusGlory;
                            this.gameState.corruption++;
                            this.showToast(`Warp Temptation! +${bonusGlory} bonus Glory, +1 Corruption!`, 'success');
                        }
                        break;
                        
                    case 'eldar':
                        // Resolve refund for high-priority missions completed within time window
                        if (duty.priority >= 3) { // Autarch rank: medium-priority missions also qualify
                            const qualifiesForRefund = (duty.priority >= 4) || (currentRankNumber >= 4 && duty.priority >= 3);
                            
                            if (qualifiesForRefund) {
                                const missionStartTime = this.gameState.factionBuffs.lastMissionTime || Date.now();
                                const timeDiff = Date.now() - missionStartTime;
                                
                                // Time windows: 4 hours base, 6 hours for Aspect Warrior+
                                const timeWindow = (currentRankNumber >= 2) ? 6 * 60 * 60 * 1000 : 4 * 60 * 60 * 1000;
                                
                                if (timeDiff <= timeWindow) {
                                    let refundChance = 0.15; // Base 15%
                                    
                                    // Exarch rank increases refund chance to 25%
                                    if (currentRankNumber >= 3) {
                                        refundChance = 0.25;
                                    }
                                    
                                    if (Math.random() < refundChance) {
                                        this.gameState.resolve = Math.min(this.gameState.maxResolve, this.gameState.resolve + 1);
                                        this.showToast('Eldar prescience! Resolve refunded for swift completion!', 'success');
                                    }
                                }
                            }
                        }
                        break;
                        
                    case 'imperial-guard':
                        // Build duty stacks for low-priority missions
                        if (duty.priority <= 2) {
                            // Guardsman rank increases cap from 5 to 6 stacks
                            const maxStacks = (currentRankNumber >= 2) ? 6 : 5;
                            
                            this.gameState.factionBuffs.dutyStacks = Math.min(maxStacks, this.gameState.factionBuffs.dutyStacks + 1);
                            this.showToast(`Duty stack gained! Glory bonus now: ${this.gameState.factionBuffs.dutyStacks * 5}%`, 'success');
                        }
                        break;
                }
            }
            
            triggerMiniWaaaghEvent() {
                if (this.duties.length === 0) return;
                
                const randomDuty = this.duties[Math.floor(Math.random() * this.duties.length)];
                let target = randomDuty.targetType === 'at-least' ? randomDuty.targetMin : 
                             Math.floor(Math.random() * (randomDuty.targetMax - randomDuty.targetMin + 1)) + randomDuty.targetMin;
                
                const miniWaaaghMission = {
                    id: Date.now() + 8888,
                    dutyId: randomDuty.id,
                    target,
                    isNew: true,
                    isSpecial: true,
                    specialType: 'mini-waaagh',
                    flavorText: `MINI-WAAAGH!: ${this.generateMissionFlavorText(randomDuty, target)} (Warboss Bonus!)`
                };
                
                this.missions.push(miniWaaaghMission);
                this.showToast('MINI-WAAAGH! The Warboss\' legend inspires another mission!', 'success');
            }
            
            showMissionCompletionToast(duty, gloryEarned, resolveCost, isFree, diminishingMultiplier) {
                let message = `Mission completed: "${duty.name}"`;
                message += `\n+${gloryEarned} Glory Points`;
                
                // Show diminishing returns info if active
                if (diminishingMultiplier < 1.0) {
                    const percentage = Math.floor(diminishingMultiplier * 100);
                    message += ` (${percentage}% due to daily completions)`;
                }
                
                if (isFree) {
                    message += '\nüåü Free completion by Emperor\'s Grace!';
                } else {
                    message += `\n-${resolveCost} Resolve`;
                }
                
                // Add faction-specific flavor
                const factionFlavor = {
                    'space-marines': 'For the Emperor!',
                    'chaos': 'Blood for the Blood God!',
                    'orks': 'WAAAGH!',
                    'eldar': 'The future is preserved.',
                    'imperial-guard': 'Duty unto death!'
                };
                
                message += `\n${factionFlavor[this.gameState.faction] || 'Victory achieved!'}`;
                
                this.showToast(message, 'success');
            }
            
            showFreeCompletionEffect() {
                const missionBoard = document.getElementById('mission-board');
                missionBoard.classList.add('free-completion');
                
                setTimeout(() => {
                    missionBoard.classList.remove('free-completion');
                }, 1500);
            }
            
            deleteMission(missionId) {
                const missionIndex = this.missions.findIndex(m => m.id === missionId);
                if (missionIndex === -1) return;
                
                this.missions.splice(missionIndex, 1);
                
                // Reset consecutive missions counter when abandoning
                this.gameState.factionBuffs.consecutiveMissions = 0;
                
                // Check for faction-specific abandonment benefits
                if (this.gameState.faction === 'chaos') {
                    const currentRankNumber = this.getCurrentRankNumber();
                    
                    // Chaos Lord rank: First abandonment per day doesn't cause corruption
                    if (currentRankNumber >= 5 && this.gameState.missionsDeletionCount === 0) {
                        this.showToast('Chaos Lord privilege: First abandonment forgiven!', 'success');
                        this.saveToStorage();
                        this.updateMissionBoard();
                        return;
                    }
                    
                    // Chosen rank: 50% chance to ignore corruption
                    if (currentRankNumber >= 3 && Math.random() < 0.5) {
                        this.showToast('Chosen resilience: Corruption ignored!', 'success');
                        this.saveToStorage();
                        this.updateMissionBoard();
                        return;
                    }
                }
                
                // Update corruption
                this.gameState.corruption++;
                this.gameState.missionsDeletionCount++;
                
                if (this.gameState.missionsDeletionCount >= 3) {
                    this.gameState.isCorrupted = true;
                    this.gameState.corruptionQuests = 0;
                    this.elements.corruptionWarning.classList.remove('hidden');
                }
                
                this.saveToStorage();
                this.updateMissionBoard();
                this.updateStats();
                this.updateFactionDisplay();
            }
            
            getCurrentRankNumber() {
                const ranks = this.factionRanks[this.gameState.faction];
                return ranks.indexOf(this.gameState.rank) + 1;
            }
            
            checkRankProgression() {
                const currentRankNumber = this.getCurrentRankNumber();
                const faction = this.gameState.faction;
                const requirements = this.gameState.rankRequirements[faction] || {};
                
                // Check for rank up (if not at max rank)
                if (currentRankNumber < 5) {
                    const nextRankNumber = currentRankNumber + 1;
                    const requiredGlory = requirements[nextRankNumber];
                    
                    if (requiredGlory && this.gameState.gloryPoints >= requiredGlory) {
                        const ranks = this.factionRanks[faction];
                        this.gameState.rank = ranks[nextRankNumber - 1];
                        
                        this.updateFactionDisplay();
                        this.updateRankBenefits();
                        this.checkTutorialProgression();
                        
                        this.showToast(`Promoted to ${this.gameState.rank}! Glory to the faction!`, 'success');
                        
                        // Apply rank 4 universal benefit: daily reset removes 1 corruption
                        if (nextRankNumber === 4) {
                            this.showToast('Rank 4 achieved! Daily reset now removes 1 Corruption point!', 'success');
                        }
                        
                        // Apply rank 5 universal benefit: +1 max resolve
                        if (nextRankNumber === 5) {
                            this.gameState.maxResolve++;
                            this.showToast('Max rank achieved! +1 Maximum Resolve granted!', 'success');
                        }
                    }
                }
                
                // Check for Paragon progression if at max rank
                if (currentRankNumber === 5) {
                    const paragonRequirement = 100 + (this.gameState.paragonRank * 10);
                    if (this.gameState.gloryPoints >= paragonRequirement) {
                        this.gameState.gloryPoints -= paragonRequirement;
                        this.gameState.paragonRank++;
                        
                        // Apply Paragon benefits
                        this.applyParagonBenefits();
                        
                        this.updateParagonBenefits();
                        this.checkTutorialProgression();
                        
                        this.showToast(`Achieved Paragon Rank ${this.gameState.paragonRank}!`, 'success');
                    }
                }
            }
            
            applyParagonBenefits() {
                const rank = this.gameState.paragonRank;
                
                // +1 max Resolve every 10 ranks (max +5)
                if (rank % 10 === 0 && this.gameState.paragonBenefits.maxResolve < 5) {
                    this.gameState.paragonBenefits.maxResolve++;
                    this.gameState.maxResolve++;
                    this.showToast(`Paragon Rank ${rank}! Maximum Resolve increased!`, 'success');
                }
                
                // +1% Glory Point gain every 5 ranks (max +25%)
                if (rank % 5 === 0 && this.gameState.paragonBenefits.gloryMultiplier < 25) {
                    this.gameState.paragonBenefits.gloryMultiplier++;
                    this.showToast(`Paragon benefit: +1% Glory Point gain!`, 'success');
                }
                
                // 1% Corruption resistance every 10 ranks (max 25%)
                if (rank % 10 === 0 && this.gameState.paragonBenefits.corruptionResistance < 25) {
                    this.gameState.paragonBenefits.corruptionResistance++;
                    this.showToast(`Paragon benefit: +1% Corruption resistance!`, 'success');
                }
                
                // +1 artifact slot every 20 ranks (max 4)
                if (rank % 20 === 0 && this.gameState.paragonBenefits.artifactSlots < 4) {
                    this.gameState.paragonBenefits.artifactSlots++;
                    this.showToast(`Paragon benefit: +1 Artifact slot!`, 'success');
                }
            }
            
            checkTutorialProgression() {
                let newProgress = this.gameState.tutorialProgress;
                
                if (this.gameState.totalMissionsCompleted >= 1 && newProgress < 2) newProgress = 2;
                if (this.getCurrentRankNumber() > 1 && newProgress < 3) newProgress = 3;
                if (this.gameState.corruption >= 5 && newProgress < 4) newProgress = 4;
                if (this.gameState.artifacts.length >= 1 && newProgress < 5) newProgress = 5;
                if (this.getCurrentRankNumber() >= 5 && newProgress < 6) newProgress = 6;
                if (this.gameState.paragonRank >= 1 && newProgress < 7) newProgress = 7;
                
                if (newProgress > this.gameState.tutorialProgress) {
                    this.gameState.tutorialProgress = newProgress;
                    this.updateTutorialProgress();
                }
            }
            
            grantRandomArtifact() {
                const artifactNames = [
                    'Blessed Bolt Pistol', 'Sacred Chain Sword', 'Purity Seal', 'Emperor\'s Grace',
                    'Chaos Icon', 'Warp Talisman', 'Daemon Blade', 'Mark of Khorne',
                    'Big Shoota', 'Choppa of Gork', 'Lucky Stick', 'WAAAGH! Banner',
                    'Shuriken Catapult', 'Wraithbone Rune', 'Spirit Stone', 'Phoenix Gem',
                    'Lasgun Upgrade', 'Flak Armor', 'Commissar\'s Cap', 'Imperial Aquila'
                ];
                
                const effects = [
                    '+10% Priority Boost', '+1 Resolve Regen', '5% Free Mission Chance',
                    'Corruption Resistance', 'Glory Point Bonus', 'Resolve Protection'
                ];
                
                const rarities = ['Common', 'Rare', 'Legendary'];
                const rarity = rarities[Math.floor(Math.random() * rarities.length)];
                
                const artifact = {
                    id: Date.now(),
                    name: artifactNames[Math.floor(Math.random() * artifactNames.length)],
                    effect: effects[Math.floor(Math.random() * effects.length)],
                    rarity: rarity,
                    duration: rarity === 'Common' ? 1 : rarity === 'Rare' ? 3 : -1 // -1 for permanent
                };
                
                // Increment total artifacts found
                this.gameState.totalArtifactsFound++;
                
                // Check if storage is full
                const storageCount = this.gameState.artifacts.filter(a => !this.gameState.equippedArtifacts.includes(a.id)).length;
                
                if (storageCount >= 10) {
                    // Storage is full, show replacement modal
                    this.showArtifactReplacementModal(artifact);
                } else {
                    // Storage has space, add directly
                    this.gameState.artifacts.push(artifact);
                    this.updateArtifactsDisplay();
                    this.updateStats();
                    this.saveToStorage();
                    this.showToast(`Artifact discovered: ${artifact.name} (${artifact.rarity})!`, 'success');
                }
            }
            
            showArtifactReplacementModal(newArtifact) {
                this.pendingArtifact = newArtifact;
                this.selectedArtifactIndex = -1;
                
                this.elements.artifactModalTitle.textContent = 'Storage Full!';
                this.elements.artifactModalMessage.innerHTML = `
                    <p>Your artifact storage is full. Replace an existing artifact or discard the new one?</p>
                    <div class="mt-3 p-3 bg-dark-400 border border-accent/30 rounded">
                        <strong>New Artifact:</strong> ${newArtifact.name} (${newArtifact.rarity})<br>
                        <span class="text-accent/70">${newArtifact.effect}</span>
                    </div>
                `;
                
                // Populate artifact selection grid
                this.populateArtifactSelectionGrid();
                
                this.elements.artifactReplace.setAttribute('disabled', 'disabled');
                this.elements.artifactModal.classList.remove('hidden');
            }
            
            populateArtifactSelectionGrid() {
                const grid = this.elements.artifactSelectionGrid;
                grid.innerHTML = '';
                
                const unequippedArtifacts = this.gameState.artifacts.filter(a => 
                    !this.gameState.equippedArtifacts.includes(a.id)
                );
                
                unequippedArtifacts.forEach((artifact, index) => {
                    const artifactDiv = document.createElement('div');
                    artifactDiv.className = 'artifact-card cursor-pointer';
                    artifactDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold artifact-rarity-${artifact.rarity.toLowerCase()}">${artifact.name}</h4>
                            <span class="text-xs text-accent/60">${artifact.rarity}</span>
                        </div>
                        <p class="text-sm text-accent/70">${artifact.effect}</p>
                        <p class="text-xs text-accent/50 mt-1">
                            Duration: ${artifact.duration === -1 ? 'Permanent' : `${artifact.duration} days`}
                        </p>
                    `;
                    
                    artifactDiv.addEventListener('click', () => {
                        // Remove selection from other artifacts
                        grid.querySelectorAll('.artifact-card').forEach(card => {
                            card.classList.remove('border-red-500');
                        });
                        
                        // Select this artifact
                        artifactDiv.classList.add('border-red-500');
                        this.selectedArtifactIndex = this.gameState.artifacts.indexOf(artifact);
                        this.elements.artifactReplace.removeAttribute('disabled');
                    });
                    
                    grid.appendChild(artifactDiv);
                });
            }
            
            discardPendingArtifact() {
                this.pendingArtifact = null;
                this.selectedArtifactIndex = -1;
                this.elements.artifactModal.classList.add('hidden');
                this.showToast('New artifact discarded.', 'error');
            }
            
            replacePendingArtifact() {
                if (this.selectedArtifactIndex === -1 || !this.pendingArtifact) return;
                
                const replacedArtifact = this.gameState.artifacts[this.selectedArtifactIndex];
                
                // Replace the artifact
                this.gameState.artifacts[this.selectedArtifactIndex] = this.pendingArtifact;
                
                this.updateArtifactsDisplay();
                this.updateStats();
                this.saveToStorage();
                
                this.showToast(`Replaced "${replacedArtifact.name}" with "${this.pendingArtifact.name}"!`, 'success');
                
                this.pendingArtifact = null;
                this.selectedArtifactIndex = -1;
                this.elements.artifactModal.classList.add('hidden');
            }
            
            equipArtifact(artifactId) {
                if (this.gameState.equippedArtifacts.includes(artifactId)) {
                    // Unequip
                    this.gameState.equippedArtifacts = this.gameState.equippedArtifacts.filter(id => id !== artifactId);
                    this.showToast('Artifact unequipped!', 'success');
                } else {
                    // Check equipment limit
                    const maxEquipped = 1 + this.gameState.paragonBenefits.artifactSlots;
                    
                    if (this.gameState.equippedArtifacts.length >= maxEquipped) {
                        this.showToast(`Maximum of ${maxEquipped} artifacts can be equipped!`, 'error');
                        return;
                    }
                    
                    // Equip
                    this.gameState.equippedArtifacts.push(artifactId);
                    this.showToast('Artifact equipped!', 'success');
                }
                
                this.updateArtifactsDisplay();
                this.saveToStorage();
            }
            
            sellArtifact(artifactId) {
                const artifactIndex = this.gameState.artifacts.findIndex(a => a.id === artifactId);
                if (artifactIndex === -1) return;
                
                const artifact = this.gameState.artifacts[artifactIndex];
                
                // Calculate sell value based on rarity
                let sellValue = 5; // Common
                if (artifact.rarity === 'Rare') sellValue = 15;
                if (artifact.rarity === 'Legendary') sellValue = 30;
                
                this.elements.confirmTitle.textContent = 'Sell Artifact';
                this.elements.confirmMessage.innerHTML = `
                    <p>Sell "${artifact.name}" for ${sellValue} Glory Points?</p>
                    <p class="text-amber-500 mt-2">This action cannot be undone.</p>
                `;
                
                this.elements.confirmOk.onclick = () => {
                    // Remove from equipped if equipped
                    this.gameState.equippedArtifacts = this.gameState.equippedArtifacts.filter(id => id !== artifactId);
                    
                    // Remove from artifacts
                    this.gameState.artifacts.splice(artifactIndex, 1);
                    
                    // Add glory points
                    this.gameState.gloryPoints += sellValue;
                    
                    // Update faction glory earned
                    this.gameState.factionGloryEarned[this.gameState.faction] += sellValue;
                    
                    // Increment total artifacts sold
                    this.gameState.totalArtifactsSold++;
                    
                    this.updateArtifactsDisplay();
                    this.updateStats();
                    this.saveToStorage();
                    
                    this.showToast(`Sold "${artifact.name}" for ${sellValue} Glory Points!`, 'success');
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            updateArtifactsDisplay() {
                const container = this.elements.artifactsContainer;
                const storageCount = this.gameState.artifacts.filter(a => !this.gameState.equippedArtifacts.includes(a.id)).length;
                const equippedCount = this.gameState.equippedArtifacts.length;
                const maxEquipped = 1 + this.gameState.paragonBenefits.artifactSlots;
                
                this.elements.artifactStorageCount.textContent = storageCount;
                this.elements.artifactEquippedCount.textContent = equippedCount;
                this.elements.artifactMaxEquipped.textContent = maxEquipped;
                
                if (this.gameState.artifacts.length === 0) {
                    container.innerHTML = '<p class="text-accent/50 text-center py-8">No artifacts discovered yet</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                // Sort artifacts: equipped first, then by rarity
                const sortedArtifacts = [...this.gameState.artifacts].sort((a, b) => {
                    const aEquipped = this.gameState.equippedArtifacts.includes(a.id);
                    const bEquipped = this.gameState.equippedArtifacts.includes(b.id);
                    
                    if (aEquipped && !bEquipped) return -1;
                    if (!aEquipped && bEquipped) return 1;
                    
                    const rarityOrder = { 'Legendary': 3, 'Rare': 2, 'Common': 1 };
                    return rarityOrder[b.rarity] - rarityOrder[a.rarity];
                });
                
                sortedArtifacts.forEach(artifact => {
                    const isEquipped = this.gameState.equippedArtifacts.includes(artifact.id);
                    const artifactDiv = document.createElement('div');
                    artifactDiv.className = `artifact-card ${isEquipped ? 'equipped' : ''}`;
                    
                    artifactDiv.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-semibold artifact-rarity-${artifact.rarity.toLowerCase()}">${artifact.name}</h4>
                            <div class="flex items-center space-x-1">
                                <span class="text-xs text-accent/60">${artifact.rarity}</span>
                                ${isEquipped ? '<span class="text-xs bg-accent text-dark px-1 rounded">EQUIPPED</span>' : ''}
                            </div>
                        </div>
                        <p class="text-sm text-accent/70 mb-2">${artifact.effect}</p>
                        <p class="text-xs text-accent/50 mb-3">
                            Duration: ${artifact.duration === -1 ? 'Permanent' : `${artifact.duration} days`}
                        </p>
                        <div class="flex space-x-2">
                            <button class="equip-artifact-btn bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-2 py-1 rounded text-xs transition-colors flex-grow" data-id="${artifact.id}">
                                ${isEquipped ? 'Unequip' : 'Equip'}
                            </button>
                            <button class="sell-artifact-btn bg-amber-900/40 hover:bg-amber-800/60 text-accent/80 border border-amber-900/30 px-2 py-1 rounded text-xs transition-colors" data-id="${artifact.id}">
                                Sell
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(artifactDiv);
                    
                    const equipBtn = artifactDiv.querySelector('.equip-artifact-btn');
                    const sellBtn = artifactDiv.querySelector('.sell-artifact-btn');
                    
                    equipBtn.addEventListener('click', () => this.equipArtifact(artifact.id));
                    sellBtn.addEventListener('click', () => this.sellArtifact(artifact.id));
                });
            }
            
            updateMissionBoard() {
                const missionContainer = this.elements.missionContainer;
                
                if (this.missions.length === 0) {
                    this.elements.emptyMissionPrompt.classList.remove('hidden');
                    missionContainer.classList.add('hidden');
                    return;
                }
                
                this.elements.emptyMissionPrompt.classList.add('hidden');
                missionContainer.classList.remove('hidden');
                
                missionContainer.innerHTML = '';
                
                this.missions.forEach(mission => {
                    const duty = this.duties.find(d => d.id === mission.dutyId);
                    if (!duty) return;
                    
                    const missionCard = document.createElement('div');
                    let cardClasses = `mission-card rounded-lg p-4 shadow-lg relative ${mission.isNew ? 'new-mission' : ''}`;
                    
                    // Add special mission styling
                    if (mission.isSpecial) {
                        cardClasses += ' special-mission';
                        if (mission.specialType === 'waaagh' || mission.specialType === 'mini-waaagh') {
                            cardClasses += ' waaagh-mission';
                        } else if (mission.specialType === 'warp-temptation') {
                            cardClasses += ' warp-temptation';
                        }
                    }
                    
                    missionCard.className = cardClasses;
                    mission.isNew = false;
                    
                    let resolveCost = this.getBaseMissionCost();
                    resolveCost = this.applyFactionResolveBonuses(resolveCost);
                    
                    const canComplete = this.gameState.resolve >= resolveCost;
                    
                    let specialBadge = '';
                    if (mission.isSpecial) {
                        if (mission.specialType === 'waaagh') {
                            specialBadge = '<div class="absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded text-xs font-bold">WAAAGH!</div>';
                        } else if (mission.specialType === 'mini-waaagh') {
                            specialBadge = '<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">MINI-WAAAGH!</div>';
                        }
                    }
                    
                    // Calculate glory with all bonuses for display
                    let displayGlory = duty.priority;
                    displayGlory = this.applyRankGloryBonuses(displayGlory);
                    displayGlory = Math.floor(displayGlory * (1 + this.gameState.paragonBenefits.gloryMultiplier / 100));
                    
                    if (mission.isSpecial && (mission.specialType === 'waaagh' || mission.specialType === 'mini-waaagh')) {
                        if (this.gameState.faction === 'orks' && this.getCurrentRankNumber() >= 3) {
                            displayGlory += 1; // Nob bonus
                        }
                        displayGlory *= 2; // Double for WAAAGH!
                    }
                    
                    // Apply diminishing returns to display
                    const diminishingMultiplier = this.getDiminishingReturnsMultiplier();
                    displayGlory = Math.floor(displayGlory * diminishingMultiplier);
                    
                    let gloryText = `Grants ${displayGlory} Glory`;
                    if (diminishingMultiplier < 1.0) {
                        const percentage = Math.floor(diminishingMultiplier * 100);
                        gloryText += ` (${percentage}% efficiency)`;
                    }
                    
                    missionCard.innerHTML = `
                        ${specialBadge}
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <span class="text-3xl mr-2">${duty.icon}</span>
                                <h3 class="text-xl font-semibold">${duty.name}</h3>
                            </div>
                            <div class="priority-indicator">
                                ${Array(5).fill(0).map((_, i) => `<div class="${i < duty.priority ? 'active' : ''}"></div>`).join('')}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-accent/70 text-sm italic mb-2">${mission.flavorText}</p>
                            <p class="text-accent text-lg mt-1 font-bold">${mission.target} ${duty.unit}</p>
                            <p class="text-xs text-accent/50 mt-1">Costs ${resolveCost} Resolve ‚Ä¢ ${gloryText}</p>
                        </div>
                        
                        <div class="flex justify-between">
                            <button class="complete-mission-btn ${canComplete ? 'bg-accent hover:bg-accent/80 text-dark' : 'bg-gray-600 cursor-not-allowed text-gray-400'} border border-accent/50 px-3 py-1.5 rounded font-semibold transition-colors flex-grow mr-1" data-id="${mission.id}" ${canComplete ? '' : 'disabled'}>
                                <i class="fas fa-check mr-1"></i> ${canComplete ? 'Complete Mission' : 'Insufficient Resolve'}
                            </button>
                            <button class="delete-mission-btn bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-3 py-1.5 rounded transition-colors" data-id="${mission.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    missionContainer.appendChild(missionCard);
                    
                    const completeBtn = missionCard.querySelector('.complete-mission-btn');
                    const deleteBtn = missionCard.querySelector('.delete-mission-btn');
                    
                    completeBtn.addEventListener('click', () => this.completeMission(mission.id));
                    deleteBtn.addEventListener('click', () => this.showDeleteMissionConfirmation(mission.id));
                });
                
                this.saveToStorage();
            }
            
            showDeleteMissionConfirmation(missionId) {
                const mission = this.missions.find(m => m.id === missionId);
                if (!mission) return;
                
                const duty = this.duties.find(d => d.id === mission.dutyId);
                if (!duty) return;
                
                this.elements.confirmTitle.textContent = 'Abandon Mission';
                
                if (this.gameState.missionsDeletionCount >= 2) {
                    this.elements.confirmMessage.innerHTML = 
                        `<p>Are you sure you want to abandon "${duty.name}"?</p>
                        <p class="text-red-500 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i> Warning: This will be your 3rd abandoned mission. You will be corrupted!</p>`;
                } else {
                    this.elements.confirmMessage.textContent = `Are you sure you want to abandon "${duty.name}"?`;
                }
                
                this.elements.confirmOk.onclick = () => {
                    this.deleteMission(missionId);
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            updateResolveDisplay() {
                const hearts = this.elements.resolveDisplay.querySelectorAll('.resolve-heart');
                
                // Add or remove hearts based on max resolve
                const currentHearts = hearts.length;
                const maxResolve = this.gameState.maxResolve;
                
                if (currentHearts !== maxResolve) {
                    this.elements.resolveDisplay.innerHTML = '';
                    for (let i = 0; i < maxResolve; i++) {
                        const heart = document.createElement('div');
                        heart.className = 'resolve-heart';
                        heart.textContent = '‚ö°';
                        this.elements.resolveDisplay.appendChild(heart);
                    }
                }
                
                const updatedHearts = this.elements.resolveDisplay.querySelectorAll('.resolve-heart');
                updatedHearts.forEach((heart, index) => {
                    if (index < this.gameState.resolve) {
                        heart.classList.add('active');
                        heart.classList.remove('depleted');
                    } else {
                        heart.classList.remove('active');
                        heart.classList.add('depleted');
                    }
                });
                
                if (this.gameState.resolve === 0) {
                    this.elements.resolveInfo.innerHTML = '<span class="text-red-500">Resolve:</span>';
                    this.elements.resolveDisplay.classList.add('animate-pulse-slow');
                } else if (this.gameState.resolve === 1) {
                    this.elements.resolveInfo.innerHTML = '<span class="text-amber-500">Resolve:</span>';
                    this.elements.resolveDisplay.classList.remove('animate-pulse-slow');
                } else {
                    this.elements.resolveInfo.innerHTML = '<span class="text-accent">Resolve:</span>';
                    this.elements.resolveDisplay.classList.remove('animate-pulse-slow');
                }
                
                this.updateResolveTimer();
                
                if (this.gameState.isCorrupted) {
                    document.body.classList.add('corrupted-ui');
                } else {
                    document.body.classList.remove('corrupted-ui');
                }
            }
            
            updateFactionDisplay() {
                const factionNames = {
                    'space-marines': 'Space Marines',
                    'chaos': 'Chaos',
                    'orks': 'Orks',
                    'eldar': 'Eldar',
                    'imperial-guard': 'Imperial Guard'
                };
                
                this.elements.factionDisplay.textContent = factionNames[this.gameState.faction];
                this.elements.factionDisplay.className = `faction-badge faction-${this.gameState.faction} cursor-help`;
                this.elements.currentRank.textContent = this.gameState.rank;
                
                // Show Paragon rank if applicable
                if (this.gameState.paragonRank > 0) {
                    this.elements.paragonDisplay.textContent = `P${this.gameState.paragonRank}`;
                    this.elements.paragonDisplay.classList.remove('hidden');
                } else {
                    this.elements.paragonDisplay.classList.add('hidden');
                }
                
                // Update rank progress bar
                this.updateRankProgressBar();
                
                // Update faction buffs display
                let buffsText = '';
                if (this.gameState.faction === 'space-marines' && this.gameState.factionBuffs.zealStacks > 0) {
                    buffsText += `<span class="buff-indicator zeal-buff">Zeal x${this.gameState.factionBuffs.zealStacks}</span>`;
                }
                if (this.gameState.faction === 'imperial-guard' && this.gameState.factionBuffs.dutyStacks > 0) {
                    buffsText += `<span class="buff-indicator duty-buff">Duty x${this.gameState.factionBuffs.dutyStacks}</span>`;
                }
                
                // Show heretical benefits if any
                Object.keys(this.gameState.hereticalBenefits).forEach(benefit => {
                    buffsText += `<span class="buff-indicator heretical-buff">${benefit} (Heretical)</span>`;
                });
                
                this.elements.factionBuffsDisplay.innerHTML = buffsText;
                
                // Update WAAAGH! button visibility
                this.updateWaaaghButton();
                
                // Update tooltips
                this.updateFactionTooltips();
                
                // Update settings display
                this.elements.factionSelect.value = this.gameState.faction;
            }
            
            updateRankProgressBar() {
                const currentRankNumber = this.getCurrentRankNumber();
                const faction = this.gameState.faction;
                const requirements = this.gameState.rankRequirements[faction] || {};
                
                if (currentRankNumber < 5) {
                    // Show progress to next rank
                    const nextRankNumber = currentRankNumber + 1;
                    const requiredGlory = requirements[nextRankNumber] || 50;
                    const progress = Math.min(100, (this.gameState.gloryPoints / requiredGlory) * 100);
                    this.elements.rankProgressFill.style.width = `${progress}%`;
                } else {
                    // Show Paragon progress
                    const paragonRequirement = 100 + (this.gameState.paragonRank * 10);
                    const progress = Math.min(100, (this.gameState.gloryPoints / paragonRequirement) * 100);
                    this.elements.rankProgressFill.style.width = `${progress}%`;
                }
            }
            
            updateWaaaghButton() {
                if (this.gameState.faction === 'orks' && this.getCurrentRankNumber() >= 4) {
                    this.elements.waaaghButtonContainer.classList.remove('hidden');
                    
                    const canUseWaaagh = !this.gameState.factionBuffs.waaaghUsedToday && this.gameState.resolve >= 2;
                    
                    if (canUseWaaagh) {
                        this.elements.waaaghButton.removeAttribute('disabled');
                        this.elements.waaaghButton.classList.remove('waaagh-button:disabled');
                    } else {
                        this.elements.waaaghButton.setAttribute('disabled', 'disabled');
                        this.elements.waaaghButton.classList.add('waaagh-button:disabled');
                    }
                } else {
                    this.elements.waaaghButtonContainer.classList.add('hidden');
                }
            }
            
            updateFactionTooltips() {
                const factionInfo = this.factionDescriptions[this.gameState.faction];
                if (factionInfo) {
                    this.elements.factionTooltipHeader.innerHTML = `<strong>${factionInfo.name}</strong><br>${factionInfo.description}`;
                }
                this.updateFactionTooltip();
            }
            
            updateFactionTooltip() {
                const selectedFaction = this.elements.factionSelect.value;
                const factionInfo = this.factionDescriptions[selectedFaction];
                if (factionInfo) {
                    this.elements.factionTooltipSettings.innerHTML = `<strong>${factionInfo.name}</strong><br>${factionInfo.description}`;
                }
            }
            
            updateStats() {
                // Update daily progress
                this.elements.missionsCompletedToday.textContent = this.gameState.completedToday;
                
                const dailyTarget = 5;
                let progressPercentage = Math.min(100, (this.gameState.completedToday / dailyTarget) * 100);
                this.elements.dailyProgressBar.style.width = `${progressPercentage}%`;
                
                // Update stats tab
                this.elements.totalMissionsElement.textContent = this.gameState.totalMissionsCompleted;
                this.elements.generationCountElement.textContent = this.gameState.generationCount;
                this.elements.highestStreakElement.textContent = this.gameState.highestStreak;
                this.elements.gloryPointsElement.textContent = this.gameState.gloryPoints;
                this.elements.corruptionLevelElement.textContent = this.gameState.corruption;
                this.elements.paragonRankElement.textContent = this.gameState.paragonRank;
                this.elements.totalArtifactsFoundElement.textContent = this.gameState.totalArtifactsFound;
                this.elements.totalArtifactsSoldElement.textContent = this.gameState.totalArtifactsSold;
                
                // Update faction progress
                this.elements.currentFactionElement.textContent = this.elements.factionDisplay.textContent;
                this.elements.factionRankElement.textContent = this.gameState.rank;
                this.elements.paragonProgressElement.textContent = this.gameState.paragonRank;
                
                const currentRankNumber = this.getCurrentRankNumber();
                const faction = this.gameState.faction;
                const requirements = this.gameState.rankRequirements[faction] || {};
                
                if (currentRankNumber < 5) {
                    const nextRankNumber = currentRankNumber + 1;
                    const required = requirements[nextRankNumber] || 50;
                    this.elements.rankProgressElement.textContent = `${this.gameState.gloryPoints} / ${required}`;
                } else {
                    this.elements.rankProgressElement.textContent = 'Max Rank Achieved';
                }
                
                // Paragon progress
                const paragonRequirement = 100 + (this.gameState.paragonRank * 10);
                this.elements.paragonNextElement.textContent = `${this.gameState.gloryPoints} / ${paragonRequirement} GP`;
                
                this.updateTypeStats();
                this.updateFactionStats();
            }
            
            updateTypeStats() {
                const typeStats = this.elements.typeStatsElement;
                typeStats.innerHTML = '';
                
                const types = Object.keys(this.gameState.typeCompletions);
                
                if (types.length === 0) {
                    typeStats.innerHTML = '<p class="text-accent/50 text-center py-4">No missions completed yet</p>';
                    return;
                }
                
                types.sort((a, b) => this.gameState.typeCompletions[b] - this.gameState.typeCompletions[a]);
                
                types.forEach(type => {
                    const count = this.gameState.typeCompletions[type];
                    
                    let icon = 'üìã';
                    const matchingDuty = this.duties.find(d => d.type === type);
                    if (matchingDuty) {
                        icon = matchingDuty.icon;
                    }
                    
                    const typeItem = document.createElement('div');
                    typeItem.className = 'flex justify-between items-center';
                    
                    typeItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">${icon}</span>
                            <span>${type}</span>
                        </div>
                        <span class="font-bold text-accent">${count}</span>
                    `;
                    
                    typeStats.appendChild(typeItem);
                });
            }
            
            updateFactionStats() {
                // Update faction missions stats
                const factionMissionsContainer = this.elements.factionMissionsStatsElement;
                factionMissionsContainer.innerHTML = '';
                
                const factionNames = {
                    'space-marines': 'Space Marines',
                    'chaos': 'Chaos',
                    'orks': 'Orks',
                    'eldar': 'Eldar',
                    'imperial-guard': 'Imperial Guard'
                };
                
                // Sort by missions completed
                const sortedFactionsByMissions = Object.entries(this.gameState.factionMissionsCompleted)
                    .sort(([,a], [,b]) => b - a);
                
                if (sortedFactionsByMissions.every(([, count]) => count === 0)) {
                    factionMissionsContainer.innerHTML = '<p class="text-accent/50 text-center py-4">No missions completed by any faction yet</p>';
                } else {
                    sortedFactionsByMissions.forEach(([faction, count]) => {
                        if (count > 0) {
                            const factionItem = document.createElement('div');
                            factionItem.className = 'flex justify-between items-center';
                            
                            factionItem.innerHTML = `
                                <div class="flex items-center">
                                    <span class="faction-badge faction-${faction} mr-2">${factionNames[faction]}</span>
                                </div>
                                <span class="font-bold text-accent">${count}</span>
                            `;
                            
                            factionMissionsContainer.appendChild(factionItem);
                        }
                    });
                }
                
                // Update faction glory stats
                const factionGloryContainer = this.elements.factionGloryStatsElement;
                factionGloryContainer.innerHTML = '';
                
                // Sort by glory earned
                const sortedFactionsByGlory = Object.entries(this.gameState.factionGloryEarned)
                    .sort(([,a], [,b]) => b - a);
                
                if (sortedFactionsByGlory.every(([, glory]) => glory === 0)) {
                    factionGloryContainer.innerHTML = '<p class="text-accent/50 text-center py-4">No glory earned by any faction yet</p>';
                } else {
                    sortedFactionsByGlory.forEach(([faction, glory]) => {
                        if (glory > 0) {
                            const factionItem = document.createElement('div');
                            factionItem.className = 'flex justify-between items-center';
                            
                            factionItem.innerHTML = `
                                <div class="flex items-center">
                                    <span class="faction-badge faction-${faction} mr-2">${factionNames[faction]}</span>
                                </div>
                                <span class="font-bold text-accent">${glory}</span>
                            `;
                            
                            factionGloryContainer.appendChild(factionItem);
                        }
                    });
                }
            }
            
            updateRankBenefits() {
                const container = this.elements.rankBenefitsElement;
                container.innerHTML = '';
                
                const currentRankNumber = this.getCurrentRankNumber();
                const faction = this.gameState.faction;
                
                if (currentRankNumber === 1) {
                    container.innerHTML = '<p class="text-accent/50 text-center py-8">Complete missions to unlock rank benefits</p>';
                    return;
                }
                
                // Universal benefits
                const universalBenefits = [];
                if (currentRankNumber >= 2) universalBenefits.push('+10% artifact discovery chance');
                if (currentRankNumber >= 3) universalBenefits.push('Resolve regeneration: 25 minutes (was 30)');
                if (currentRankNumber >= 4) universalBenefits.push('Daily reset removes 1 Corruption point');
                if (currentRankNumber >= 5) universalBenefits.push('+1 Maximum Resolve');
                
                // Faction-specific benefits
                const factionBenefits = this.getFactionSpecificBenefits(faction, currentRankNumber);
                
                // Display universal benefits
                if (universalBenefits.length > 0) {
                    const universalHeader = document.createElement('h4');
                    universalHeader.className = 'font-semibold mb-2';
                    universalHeader.textContent = 'Universal Benefits:';
                    container.appendChild(universalHeader);
                    
                    universalBenefits.forEach(benefit => {
                        const benefitDiv = document.createElement('div');
                        benefitDiv.className = 'rank-benefit';
                        benefitDiv.textContent = `‚Ä¢ ${benefit}`;
                        container.appendChild(benefitDiv);
                    });
                }
                
                // Display faction benefits
                if (factionBenefits.length > 0) {
                    const factionHeader = document.createElement('h4');
                    factionHeader.className = 'font-semibold mb-2 mt-4';
                    factionHeader.textContent = `${faction.charAt(0).toUpperCase() + faction.slice(1).replace('-', ' ')} Benefits:`;
                    container.appendChild(factionHeader);
                    
                    factionBenefits.forEach(benefit => {
                        const benefitDiv = document.createElement('div');
                        benefitDiv.className = 'rank-benefit';
                        benefitDiv.textContent = `‚Ä¢ ${benefit}`;
                        container.appendChild(benefitDiv);
                    });
                }
                
                // Display heretical benefits if any
                if (Object.keys(this.gameState.hereticalBenefits).length > 0) {
                    const hereticalHeader = document.createElement('h4');
                    hereticalHeader.className = 'font-semibold mb-2 mt-4 text-red-400';
                    hereticalHeader.textContent = 'Heretical Benefits (75% effectiveness):';
                    container.appendChild(hereticalHeader);
                    
                    Object.keys(this.gameState.hereticalBenefits).forEach(benefit => {
                        const benefitDiv = document.createElement('div');
                        benefitDiv.className = 'rank-benefit heretical';
                        benefitDiv.textContent = `‚Ä¢ ${benefit}`;
                        container.appendChild(benefitDiv);
                    });
                }
            }
            
            getFactionSpecificBenefits(faction, rankNumber) {
                const benefits = [];
                
                switch (faction) {
                    case 'space-marines':
                        if (rankNumber >= 2) benefits.push('Zeal buff lasts +1 additional mission');
                        if (rankNumber >= 3) benefits.push('High-priority missions get +25% selection weight');
                        if (rankNumber >= 4) benefits.push('All missions cost -1 Resolve (minimum 1)');
                        if (rankNumber >= 5) benefits.push('+50% Glory Points from all missions');
                        break;
                        
                    case 'chaos':
                        if (rankNumber >= 2) benefits.push('Warp Temptation chance: 10% ‚Üí 15%');
                        if (rankNumber >= 3) benefits.push('50% chance to ignore Corruption when abandoning');
                        if (rankNumber >= 4) benefits.push('Warp Temptation grants +100% bonus Glory');
                        if (rankNumber >= 5) benefits.push('First mission abandonment each day doesn\'t cause Corruption');
                        break;
                        
                    case 'orks':
                        if (rankNumber >= 2) benefits.push('WAAAGH! event chance: 20% ‚Üí 25%');
                        if (rankNumber >= 3) benefits.push('WAAAGH! missions grant +1 extra Glory Point');
                        if (rankNumber >= 4) benefits.push('Can trigger WAAAGH! manually once per day');
                        if (rankNumber >= 5) benefits.push('All missions have 10% chance to trigger mini-WAAAGH!');
                        break;
                        
                    case 'eldar':
                        if (rankNumber >= 2) benefits.push('Resolve refund time window: 4 ‚Üí 6 hours');
                        if (rankNumber >= 3) benefits.push('Resolve refund chance: 15% ‚Üí 25%');
                        if (rankNumber >= 4) benefits.push('Medium-priority missions also qualify for refund');
                        if (rankNumber >= 5) benefits.push('Failed time window: +1 Corruption instead of +2');
                        break;
                        
                    case 'imperial-guard':
                        if (rankNumber >= 2) benefits.push('Duty stacks cap: 5 ‚Üí 6 stacks');
                        if (rankNumber >= 3) benefits.push('Low-priority missions get +20% selection weight');
                        if (rankNumber >= 4) benefits.push('Duty stacks decay by -1 per day instead of resetting');
                        if (rankNumber >= 5) benefits.push('Maximum Duty bonus: 25% ‚Üí 35% Glory');
                        break;
                }
                
                return benefits;
            }
            
            updateParagonBenefits() {
                const container = this.elements.paragonBenefitsElement;
                container.innerHTML = '';
                
                if (this.gameState.paragonRank === 0) {
                    container.innerHTML = '<p class="text-accent/50 text-center py-8">Reach max rank to begin Paragon progression</p>';
                    return;
                }
                
                const benefits = [];
                
                if (this.gameState.paragonBenefits.maxResolve > 0) {
                    benefits.push(`+${this.gameState.paragonBenefits.maxResolve} Maximum Resolve`);
                }
                
                if (this.gameState.paragonBenefits.gloryMultiplier > 0) {
                    benefits.push(`+${this.gameState.paragonBenefits.gloryMultiplier}% Glory Point gain`);
                }
                
                if (this.gameState.paragonBenefits.corruptionResistance > 0) {
                    benefits.push(`${this.gameState.paragonBenefits.corruptionResistance}% Corruption resistance`);
                }
                
                if (this.gameState.paragonBenefits.artifactSlots > 0) {
                    benefits.push(`+${this.gameState.paragonBenefits.artifactSlots} Artifact slots`);
                }
                
                if (benefits.length === 0) {
                    container.innerHTML = '<p class="text-accent/50 text-center py-8">No Paragon benefits unlocked yet</p>';
                    return;
                }
                
                const header = document.createElement('h4');
                header.className = 'font-semibold mb-2';
                header.textContent = `Paragon Rank ${this.gameState.paragonRank} Benefits:`;
                container.appendChild(header);
                
                benefits.forEach(benefit => {
                    const benefitDiv = document.createElement('div');
                    benefitDiv.className = 'rank-benefit';
                    benefitDiv.textContent = `‚Ä¢ ${benefit}`;
                    container.appendChild(benefitDiv);
                });
            }
            
            updateTutorialProgress() {
                this.elements.tutorialCount.textContent = this.gameState.tutorialProgress;
                
                const tutorialEntries = [
                    {
                        title: "The Emperor's Service",
                        content: "Welcome, faithful servant. The Mission Board channels the Emperor's will, transforming your mundane tasks into sacred duties. Input activities in the Archives, then receive divine missions to crush procrastination and serve the Imperium. Complete missions to earn Glory Points and prove your worth."
                    },
                    {
                        title: "Resolve and Duty",
                        content: "Your Resolve represents your spiritual and physical fortitude in service to the Emperor. Each completed mission consumes 1 Resolve (2 if corrupted), but the Emperor occasionally grants free completion through divine grace. Resolve regenerates at 1 point every 30 minutes - use this time wisely for contemplation."
                    },
                    {
                        title: "The Taint of Corruption", 
                        content: "Beware the corruption of Chaos! Abandoning missions taints your soul with heretical weakness. Accumulate too much corruption and mission completion will cost additional Resolve. Purge this taint by completing consecutive missions without abandonment - show the Emperor your unwavering dedication."
                    },
                    {
                        title: "Faction Powers",
                        content: "The galaxy is filled with blessed relics and cursed artifacts. Complete missions and events to discover these items, which provide various boons to aid your service. Each faction also grants unique abilities: Space Marines gain Zeal for consecutive missions, Orks have WAAAGH! events, Chaos tempts with Warp power, Eldar refund Resolve for swift completion, and Imperial Guard build Duty for persistent service."
                    },
                    {
                        title: "Sacred Artifacts",
                        content: "Artifacts are precious relics discovered through your service to the Emperor. Each has unique effects and rarities - Common artifacts last 1 day, Rare last 3 days, and Legendary are permanent. Store up to 10 artifacts and equip them for active benefits. Sell unwanted artifacts for Glory Points, but choose wisely - some effects are irreplaceable! Your artifact discoveries and sales are tracked in the Tactical Slate."
                    },
                    {
                        title: "Ranks and Progression",
                        content: "Advance through your faction's ranks by earning Glory Points through mission completion. Each rank grants powerful benefits that enhance your capabilities. Universal benefits like faster Resolve regeneration and increased artifact discovery apply to all factions, while faction-specific benefits amplify your chosen allegiance's unique strengths. Your progression in each faction is tracked separately - view faction-specific statistics in the Tactical Slate."
                    },
                    {
                        title: "Paragon of the Imperium",
                        content: "True servants of the Emperor never cease their duty. Upon reaching the highest rank in your faction, you begin the path of Paragon - an endless progression of increasing legend and capability. Paragon Ranks grant permanent benefits like increased maximum Resolve, Glory Point bonuses, corruption resistance, and artifact slots. Your dedication shall echo through eternity! Be aware: Excessive daily mission completion may result in diminishing Glory returns as your spirit grows weary - pace yourself for optimal service."
                    }
                ];
                
                this.elements.tutorialEntries.innerHTML = '';
                
                for (let i = 0; i < this.gameState.tutorialProgress; i++) {
                    const entry = tutorialEntries[i];
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'border border-accent/30 rounded p-4 bg-dark-500';
                    entryDiv.innerHTML = `
                        <h3 class="gothic font-semibold text-accent mb-2">${entry.title}</h3>
                        <p class="text-accent/80 text-sm">${entry.content}</p>
                    `;
                    this.elements.tutorialEntries.appendChild(entryDiv);
                }
            }
            
            showDutyForm(duty = null) {
                this.elements.dutyForm.reset();
                
                this.elements.customType.classList.add('hidden');
                this.elements.customObject.classList.add('hidden');
                this.elements.customUnit.classList.add('hidden');
                
                this.elements.iconButtons.forEach(btn => btn.classList.remove('bg-accent/40'));
                this.elements.iconButtons[0].classList.add('bg-accent/40');
                this.elements.selectedIcon.value = 'üìö';
                
                this.elements.priorityValue.textContent = '3';
                
                if (duty) {
                    document.getElementById('form-title').textContent = 'Edit Duty';
                    document.getElementById('duty-id').value = duty.id;
                    
                    if (this.elements.dutyTypeSelect.querySelector(`option[value="${duty.type}"]`)) {
                        this.elements.dutyTypeSelect.value = duty.type;
                    } else {
                        this.elements.dutyTypeSelect.value = 'custom';
                        this.elements.customType.value = duty.type;
                        this.elements.customType.classList.remove('hidden');
                    }
                    
                    if (this.elements.dutyObjectSelect.querySelector(`option[value="${duty.object}"]`)) {
                        this.elements.dutyObjectSelect.value = duty.object;
                    } else {
                        this.elements.dutyObjectSelect.value = 'custom';
                        this.elements.customObject.value = duty.object;
                        this.elements.customObject.classList.remove('hidden');
                    }
                    
                    document.getElementById('duty-name').value = duty.name;
                    
                    this.elements.dutyTargetType.value = duty.targetType;
                    this.elements.dutyTargetMin.value = duty.targetMin;
                    
                    if (duty.targetType === 'range') {
                        this.elements.dutyTargetMax.value = duty.targetMax;
                        this.elements.dutyTargetMax.removeAttribute('disabled');
                    } else {
                        this.elements.dutyTargetMax.setAttribute('disabled', 'disabled');
                    }
                    
                    if (this.elements.dutyUnitSelect.querySelector(`option[value="${duty.unit}"]`)) {
                        this.elements.dutyUnitSelect.value = duty.unit;
                    } else {
                        this.elements.dutyUnitSelect.value = 'custom';
                        this.elements.customUnit.value = duty.unit;
                        this.elements.customUnit.classList.remove('hidden');
                    }
                    
                    this.elements.dutyPriority.value = duty.priority;
                    this.elements.priorityValue.textContent = duty.priority;
                    
                    this.elements.selectedIcon.value = duty.icon;
                    const iconBtn = Array.from(this.elements.iconButtons).find(btn => 
                        btn.getAttribute('data-icon') === duty.icon
                    );
                    
                    if (iconBtn) {
                        this.elements.iconButtons.forEach(btn => btn.classList.remove('bg-accent/40'));
                        iconBtn.classList.add('bg-accent/40');
                    }
                } else {
                    document.getElementById('form-title').textContent = 'Inscribe New Duty';
                    document.getElementById('duty-id').value = '';
                }
                
                this.elements.dutyFormContainer.classList.remove('hidden');
            }
            
            hideDutyForm() {
                this.elements.dutyFormContainer.classList.add('hidden');
            }
            
            saveDuty() {
                const id = document.getElementById('duty-id').value;
                let type, object, unit;
                
                if (this.elements.dutyTypeSelect.value === 'custom') {
                    type = this.elements.customType.value.trim();
                } else {
                    type = this.elements.dutyTypeSelect.value;
                }
                
                if (this.elements.dutyObjectSelect.value === 'custom') {
                    object = this.elements.customObject.value.trim();
                } else {
                    object = this.elements.dutyObjectSelect.value;
                }
                
                if (this.elements.dutyUnitSelect.value === 'custom') {
                    unit = this.elements.customUnit.value.trim();
                } else {
                    unit = this.elements.dutyUnitSelect.value;
                }
                
                const name = document.getElementById('duty-name').value.trim();
                if (!name) return;
                
                const targetType = this.elements.dutyTargetType.value;
                const targetMin = parseInt(this.elements.dutyTargetMin.value);
                const targetMax = targetType === 'range' ? parseInt(this.elements.dutyTargetMax.value) : targetMin;
                const priority = parseInt(this.elements.dutyPriority.value);
                const icon = this.elements.selectedIcon.value;
                
                const duty = {
                    type,
                    object,
                    name,
                    targetType,
                    targetMin,
                    targetMax,
                    unit,
                    priority,
                    icon,
                    lastCompleted: null
                };
                
                if (id) {
                    const index = this.duties.findIndex(d => d.id === parseInt(id));
                    if (index !== -1) {
                        duty.id = parseInt(id);
                        duty.lastCompleted = this.duties[index].lastCompleted;
                        this.duties[index] = duty;
                    }
                } else {
                    duty.id = this.nextId++;
                    this.duties.push(duty);
                }
                
                this.saveToStorage();
                this.updateDutyList();
                this.hideDutyForm();
            }
            
            updateDutyList() {
                const dutyList = this.elements.dutyList;
                dutyList.innerHTML = '';
                
                if (this.duties.length === 0) {
                    this.elements.emptyDutyList.classList.remove('hidden');
                } else {
                    this.elements.emptyDutyList.classList.add('hidden');
                    
                    this.duties.forEach(duty => {
                        const dutyItem = document.createElement('div');
                        dutyItem.className = 'bg-dark-400 border border-accent/30 rounded-lg p-3 mb-2 relative';
                        
                        let priorityHtml = '<div class="priority-indicator absolute top-3 right-3">';
                        for (let i = 1; i <= 5; i++) {
                            priorityHtml += `<div class="${i <= duty.priority ? 'active' : ''}"></div>`;
                        }
                        priorityHtml += '</div>';
                        
                        let targetText = '';
                        if (duty.targetType === 'at-least') {
                            targetText = `at least ${duty.targetMin} ${duty.unit}`;
                        } else {
                            targetText = `${duty.targetMin} to ${duty.targetMax} ${duty.unit}`;
                        }
                        
                        dutyItem.innerHTML = `
                            <div class="flex items-start">
                                <div class="flex-shrink-0 mt-0.5">
                                    <input type="checkbox" class="duty-checkbox" data-id="${duty.id}">
                                </div>
                                <div class="ml-3 flex-grow">
                                    <div class="flex items-center mb-1">
                                        <span class="text-2xl mr-2">${duty.icon}</span>
                                        <h4 class="text-lg font-semibold">${duty.name}</h4>
                                    </div>
                                    <p class="text-accent/70 text-sm">
                                        ${duty.type} ${duty.object}, ${targetText}
                                    </p>
                                </div>
                                ${priorityHtml}
                            </div>
                            <div class="flex justify-end mt-2 space-x-2">
                                <button class="edit-duty-btn bg-dark-300 hover:bg-dark-200 text-accent/80 border border-accent/20 px-2 py-1 rounded text-sm transition-colors" data-id="${duty.id}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="delete-duty-btn bg-red-900/40 hover:bg-red-800/60 text-accent/80 border border-red-900/30 px-2 py-1 rounded text-sm transition-colors" data-id="${duty.id}">
                                    <i class="fas fa-trash"></i> Purge
                                </button>
                            </div>
                        `;
                        
                        dutyList.appendChild(dutyItem);
                        
                        const editBtn = dutyItem.querySelector('.edit-duty-btn');
                        const deleteBtn = dutyItem.querySelector('.delete-duty-btn');
                        const checkbox = dutyItem.querySelector('.duty-checkbox');
                        
                        editBtn.addEventListener('click', () => this.editDuty(duty.id));
                        deleteBtn.addEventListener('click', () => this.showDeleteDutyConfirmation(duty.id));
                        checkbox.addEventListener('change', () => this.updateDeleteSelectedButton());
                    });
                }
            }
            
            editDuty(id) {
                const duty = this.duties.find(d => d.id === id);
                if (duty) {
                    this.showDutyForm(duty);
                }
            }
            
            showDeleteDutyConfirmation(id) {
                const duty = this.duties.find(d => d.id === id);
                if (!duty) return;
                
                this.elements.confirmTitle.textContent = 'Purge Duty';
                this.elements.confirmMessage.textContent = `Remove "${duty.name}" from the sacred archives?`;
                
                this.elements.confirmOk.onclick = () => {
                    this.deleteDuty(id);
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            deleteDuty(id) {
                this.duties = this.duties.filter(d => d.id !== id);
                this.missions = this.missions.filter(m => m.dutyId !== id);
                
                this.saveToStorage();
                this.updateDutyList();
                this.updateMissionBoard();
            }
            
            toggleSelectAll() {
                const checkboxes = document.querySelectorAll('.duty-checkbox');
                const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
                
                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allChecked;
                });
                
                this.updateDeleteSelectedButton();
            }
            
            updateDeleteSelectedButton() {
                const checkboxes = document.querySelectorAll('.duty-checkbox');
                const checkedCount = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
                
                if (checkedCount > 0) {
                    this.elements.deleteSelectedBtn.removeAttribute('disabled');
                    this.elements.deleteSelectedBtn.classList.remove('text-accent/50', 'cursor-not-allowed', 'bg-red-900/40');
                    this.elements.deleteSelectedBtn.classList.add('text-accent', 'bg-red-900/80', 'hover:bg-red-800');
                } else {
                    this.elements.deleteSelectedBtn.setAttribute('disabled', 'disabled');
                    this.elements.deleteSelectedBtn.classList.add('text-accent/50', 'cursor-not-allowed', 'bg-red-900/40');
                    this.elements.deleteSelectedBtn.classList.remove('text-accent', 'bg-red-900/80', 'hover:bg-red-800');
                }
            }
            
            showDeleteSelectedConfirmation() {
                const checkboxes = document.querySelectorAll('.duty-checkbox:checked');
                const count = checkboxes.length;
                
                if (count === 0) return;
                
                this.elements.confirmTitle.textContent = 'Purge Duties';
                this.elements.confirmMessage.textContent = `Are you sure you want to purge ${count} selected ${count === 1 ? 'duty' : 'duties'}?`;
                
                this.elements.confirmOk.onclick = () => {
                    const idsToDelete = Array.from(checkboxes).map(checkbox => 
                        parseInt(checkbox.getAttribute('data-id'))
                    );
                    
                    this.duties = this.duties.filter(duty => 
                        !idsToDelete.includes(duty.id)
                    );
                    
                    this.missions = this.missions.filter(mission => 
                        !idsToDelete.includes(mission.dutyId)
                    );
                    
                    this.saveToStorage();
                    this.updateDutyList();
                    this.updateMissionBoard();
                    
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            changeFaction() {
                const newFaction = this.elements.factionSelect.value;
                
                if (newFaction === this.gameState.faction) {
                    this.showWarning('You are already pledged to this faction!');
                    return;
                }
                
                const reallegianceCost = Math.max(50, Math.floor(this.gameState.gloryPoints * 0.1));
                
                this.elements.confirmTitle.textContent = 'Change Allegiance';
                this.elements.confirmMessage.innerHTML = `
                    <p>Pledge allegiance to ${this.factionDescriptions[newFaction].name}?</p>
                    <p class="text-amber-500 mt-2">Cost: ${reallegianceCost} Glory Points</p>
                    <p class="text-amber-500 mt-1">Note: Your rank will reset but Paragon progress is preserved.</p>
                `;
                
                this.elements.confirmOk.onclick = () => {
                    if (this.gameState.gloryPoints < reallegianceCost) {
                        this.showToast('Insufficient Glory Points for reallegiance!', 'error');
                        this.elements.confirmModal.classList.add('hidden');
                        return;
                    }
                    
                    // Store current faction benefits as heretical
                    const currentRankNumber = this.getCurrentRankNumber();
                    if (currentRankNumber > 1) {
                        const currentFactionBenefits = this.getFactionSpecificBenefits(this.gameState.faction, currentRankNumber);
                        currentFactionBenefits.forEach(benefit => {
                            this.gameState.hereticalBenefits[benefit] = true;
                        });
                    }
                    
                    this.gameState.gloryPoints -= reallegianceCost;
                    this.gameState.faction = newFaction;
                    this.gameState.rank = this.factionRanks[newFaction][0]; // Reset to first rank
                    this.gameState.redemptionProgress = 0;
                    
                    // Initialize rank requirements for new faction if needed
                    this.initializeRankRequirements();
                    
                    // Reset faction-specific buffs
                    this.gameState.factionBuffs = {
                        zealStacks: 0,
                        dutyStacks: 0,
                        lastMissionTime: null,
                        consecutiveMissions: 0,
                        zealDuration: 0,
                        waaaghUsedToday: false,
                        lastDayReset: new Date().toDateString()
                    };
                    
                    this.updateFactionDisplay();
                    this.updateStats();
                    this.updateRankBenefits();
                    this.saveToStorage();
                    
                    this.showToast(`Allegiance changed! Welcome to the ${this.elements.factionDisplay.textContent}!`, 'success');
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            manualSave() {
                this.saveToStorage();
                this.showToast('Game state saved successfully!', 'success');
            }
            
            exportGameData() {
                this.elements.importContainer.classList.add('hidden');
                this.elements.exportContainer.classList.remove('hidden');
                
                const exportData = {
                    duties: this.duties,
                    missions: this.missions,
                    nextId: this.nextId,
                    gameState: this.gameState,
                    version: '3.2.0'
                };
                
                const exportString = btoa(JSON.stringify(exportData));
                this.elements.exportText.value = exportString;
                
                // Copy to clipboard
                this.elements.exportText.select();
                try {
                    document.execCommand('copy');
                    this.showToast('Game data exported and copied to clipboard!', 'success');
                } catch (err) {
                    this.showToast('Export complete - copy the text manually.', 'success');
                }
            }
            
            showImportData() {
                this.elements.exportContainer.classList.add('hidden');
                this.elements.importContainer.classList.remove('hidden');
            }
            
            importGameData() {
                try {
                    const importString = this.elements.importText.value.trim();
                    
                    if (!importString) {
                        throw new Error('Import data is empty');
                    }
                    
                    const importData = JSON.parse(atob(importString));
                    
                    if (!importData.duties || !importData.missions || !importData.gameState) {
                        throw new Error('Import data is invalid');
                    }
                    
                    this.duties = importData.duties;
                    this.missions = importData.missions;
                    this.nextId = importData.nextId;
                    this.gameState = {
                        ...this.gameState,
                        ...importData.gameState,
                        // Ensure new fields exist with defaults
                        rankRequirements: importData.gameState.rankRequirements || {},
                        rankBenefits: importData.gameState.rankBenefits || {},
                        paragonBenefits: {
                            maxResolve: 0,
                            gloryMultiplier: 0,
                            corruptionResistance: 0,
                            artifactSlots: 0,
                            ...importData.gameState.paragonBenefits
                        },
                        hereticalBenefits: importData.gameState.hereticalBenefits || {},
                        redemptionProgress: importData.gameState.redemptionProgress || 0,
                        factionBuffs: {
                            zealStacks: 0,
                            dutyStacks: 0,
                            lastMissionTime: null,
                            consecutiveMissions: 0,
                            zealDuration: 0,
                            waaaghUsedToday: false,
                            lastDayReset: new Date().toDateString(),
                            ...importData.gameState.factionBuffs
                        },
                        // Initialize new stats if missing
                        totalArtifactsFound: importData.gameState.totalArtifactsFound || 0,
                        totalArtifactsSold: importData.gameState.totalArtifactsSold || 0,
                        factionMissionsCompleted: {
                            'space-marines': 0,
                            'chaos': 0,
                            'orks': 0,
                            'eldar': 0,
                            'imperial-guard': 0,
                            ...importData.gameState.factionMissionsCompleted
                        },
                        factionGloryEarned: {
                            'space-marines': 0,
                            'chaos': 0,
                            'orks': 0,
                            'eldar': 0,
                            'imperial-guard': 0,
                            ...importData.gameState.factionGloryEarned
                        }
                    };
                    
                    // Initialize rank requirements if missing (with new doubled values)
                    this.initializeRankRequirements();
                    
                    this.saveToStorage();
                    this.updateMissionBoard();
                    this.updateDutyList();
                    this.updateResolveDisplay();
                    this.updateStats();
                    this.updateFactionDisplay();
                    this.updateTutorialProgress();
                    this.updateRankBenefits();
                    this.updateParagonBenefits();
                    this.updateArtifactsDisplay();
                    this.updateDiminishingReturnsWarning();
                    
                    this.elements.importContainer.classList.add('hidden');
                    this.showToast('Game data imported successfully!', 'success');
                    
                } catch (error) {
                    this.showToast('Import failed: Invalid data format!', 'error');
                    console.error('Import error:', error);
                }
            }
            
            showHardResetConfirmation() {
                this.elements.confirmTitle.textContent = 'Purge All Data';
                this.elements.confirmMessage.innerHTML = 
                    `<p class="text-red-500 font-bold mb-2">Warning: This will erase ALL your data!</p>
                     <p>Are you sure you want to reset everything? This action cannot be undone.</p>`;
                
                this.elements.confirmOk.onclick = () => {
                    this.hardReset();
                    this.elements.confirmModal.classList.add('hidden');
                };
                
                this.elements.confirmModal.classList.remove('hidden');
            }
            
            hardReset() {
                this.duties = [];
                this.missions = [];
                this.nextId = 1;
                
                this.gameState = {
                    totalMissionsCompleted: 0,
                    generationCount: 0,
                    highestStreak: 0,
                    typeCompletions: {},
                    lastDayCompleted: null,
                    currentStreak: 0,
                    completedToday: 0,
                    lastReset: new Date().toDateString(),
                    faction: 'space-marines',
                    rank: 'Initiate',
                    gloryPoints: 0,
                    paragonRank: 0,
                    corruption: 0,
                    tutorialProgress: 1,
                    resolve: 5,
                    maxResolve: 5,
                    lastResolveRegeneration: Date.now(),
                    isCorrupted: false,
                    corruptionQuests: 0,
                    missionsDeletionCount: 0,
                    artifacts: [],
                    equippedArtifacts: [],
                    totalArtifactsFound: 0,
                    totalArtifactsSold: 0,
                    factionMissionsCompleted: {
                        'space-marines': 0,
                        'chaos': 0,
                        'orks': 0,
                        'eldar': 0,
                        'imperial-guard': 0
                    },
                    factionGloryEarned: {
                        'space-marines': 0,
                        'chaos': 0,
                        'orks': 0,
                        'eldar': 0,
                        'imperial-guard': 0
                    },
                    factionBuffs: {
                        zealStacks: 0,
                        dutyStacks: 0,
                        lastMissionTime: null,
                        consecutiveMissions: 0,
                        zealDuration: 0,
                        waaaghUsedToday: false,
                        lastDayReset: new Date().toDateString()
                    },
                    rankRequirements: {},
                    rankBenefits: {},
                    paragonBenefits: {
                        maxResolve: 0,
                        gloryMultiplier: 0,
                        corruptionResistance: 0,
                        artifactSlots: 0
                    },
                    hereticalBenefits: {},
                    redemptionProgress: 0
                };
                
                localStorage.removeItem('dutyEternalData');
                
                // Initialize rank requirements
                this.initializeRankRequirements();
                
                this.updateMissionBoard();
                this.updateDutyList();
                this.updateResolveDisplay();
                this.updateStats();
                this.updateFactionDisplay();
                this.updateTutorialProgress();
                this.updateRankBenefits();
                this.updateParagonBenefits();
                this.updateArtifactsDisplay();
                this.updateDiminishingReturnsWarning();
                
                this.elements.corruptionWarning.classList.add('hidden');
                
                this.showToast('All data purged! The Emperor welcomes your renewed service.', 'success');
            }
            
            checkDayChange() {
                const today = new Date().toDateString();
                
                if (this.gameState.lastReset !== today) {
                    this.gameState.lastReset = today;
                    this.gameState.completedToday = 0;
                    this.gameState.missionsDeletionCount = 0;
                    
                    // Reset daily faction buffs
                    this.gameState.factionBuffs.waaaghUsedToday = false;
                    this.gameState.factionBuffs.lastDayReset = today;
                    
                    // Apply rank 4 universal benefit: daily reset removes 1 corruption
                    if (this.getCurrentRankNumber() >= 4 && this.gameState.corruption > 0) {
                        this.gameState.corruption = Math.max(0, this.gameState.corruption - 1);
                        this.showToast('Daily reset: -1 Corruption removed!', 'success');
                    }
                    
                    // Sergeant rank: Duty stacks decay by -1 per day instead of resetting
                    if (this.gameState.faction === 'imperial-guard' && this.getCurrentRankNumber() >= 4) {
                        this.gameState.factionBuffs.dutyStacks = Math.max(0, this.gameState.factionBuffs.dutyStacks - 1);
                    } else {
                        // Normal decay for other factions/ranks
                        this.gameState.factionBuffs.dutyStacks = 0;
                    }
                    
                    if (this.gameState.lastDayCompleted === new Date(Date.now() - 24*60*60*1000).toDateString()) {
                        this.gameState.currentStreak++;
                    } else if (this.gameState.lastDayCompleted !== today) {
                        this.gameState.currentStreak = 0;
                    }
                    
                    if (this.gameState.currentStreak > this.gameState.highestStreak) {
                        this.gameState.highestStreak = this.gameState.currentStreak;
                    }
                    
                    // Check redemption progress for heretical benefits
                    if (Object.keys(this.gameState.hereticalBenefits).length > 0) {
                        this.gameState.redemptionProgress++;
                        if (this.gameState.redemptionProgress >= 3) {
                            // Redemption completed: convert heretical benefits to 50% effectiveness
                            this.gameState.hereticalBenefits = {};
                            this.gameState.redemptionProgress = 0;
                            this.showToast('Redemption achieved! Former faction benefits restored at 50% effectiveness.', 'success');
                        }
                    }
                    
                    // Update artifact durations
                    this.updateArtifactDurations();
                    
                    this.saveToStorage();
                }
            }
            
            updateArtifactDurations() {
                let artifactsExpired = 0;
                
                this.gameState.artifacts = this.gameState.artifacts.filter(artifact => {
                    if (artifact.duration > 0) {
                        artifact.duration--;
                        if (artifact.duration === 0) {
                            // Remove from equipped if equipped
                            this.gameState.equippedArtifacts = this.gameState.equippedArtifacts.filter(id => id !== artifact.id);
                            artifactsExpired++;
                            return false;
                        }
                    }
                    return true;
                });
                
                if (artifactsExpired > 0) {
                    this.showToast(`${artifactsExpired} artifact${artifactsExpired > 1 ? 's' : ''} expired and vanished!`, 'error');
                    this.updateArtifactsDisplay();
                }
            }
            
            showWarning(message, type = 'warning') {
                this.elements.warningMessage.textContent = message;
                
                // Reset classes
                this.elements.missionWarning.classList.remove(
                    'bg-amber-900/20', 'border-amber-600/50', 'text-amber-200',
                    'bg-green-900/20', 'border-green-600/50', 'text-green-200'
                );
                
                if (type === 'success') {
                    this.elements.missionWarning.classList.add('bg-green-900/20', 'border-green-600/50', 'text-green-200');
                } else {
                    this.elements.missionWarning.classList.add('bg-amber-900/20', 'border-amber-600/50', 'text-amber-200');
                }
                
                this.elements.missionWarning.classList.remove('hidden');
                
                setTimeout(() => {
                    this.elements.missionWarning.classList.add('hidden');
                }, 3000);
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message.replace(/\n/g, '<br>')}`;
                
                if (type === 'success') {
                    toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message.replace(/\n/g, '<br>')}`;
                } else if (type === 'error') {
                    toast.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message.replace(/\n/g, '<br>')}`;
                }
                
                this.elements.toastContainer.appendChild(toast);
                
                // Auto remove after 4 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 4000);
            }
            
            saveToStorage() {
                try {
                    const dataToSave = {
                        duties: this.duties,
                        missions: this.missions,
                        nextId: this.nextId,
                        gameState: this.gameState
                    };
                    
                    const encodedData = btoa(JSON.stringify(dataToSave));
                    localStorage.setItem('dutyEternalData', encodedData);
                } catch (e) {
                    console.error('Error saving to localStorage:', e);
                }
            }
            
            loadFromStorage() {
                try {
                    const encodedData = localStorage.getItem('dutyEternalData');
                    
                    if (encodedData) {
                        const data = JSON.parse(atob(encodedData));
                        
                        this.duties = data.duties || [];
                        this.missions = data.missions || [];
                        this.nextId = data.nextId || 1;
                        
                        // Merge saved game state with defaults
                        this.gameState = {
                            ...this.gameState,
                            ...data.gameState,
                            // Ensure new fields exist with defaults
                            rankRequirements: data.gameState?.rankRequirements || {},
                            rankBenefits: data.gameState?.rankBenefits || {},
                            paragonBenefits: {
                                maxResolve: 0,
                                gloryMultiplier: 0,
                                corruptionResistance: 0,
                                artifactSlots: 0,
                                ...data.gameState?.paragonBenefits
                            },
                            hereticalBenefits: data.gameState?.hereticalBenefits || {},
                            redemptionProgress: data.gameState?.redemptionProgress || 0,
                            factionBuffs: {
                                zealStacks: 0,
                                dutyStacks: 0,
                                lastMissionTime: null,
                                consecutiveMissions: 0,
                                zealDuration: 0,
                                waaaghUsedToday: false,
                                lastDayReset: new Date().toDateString(),
                                ...data.gameState?.factionBuffs
                            },
                            // Initialize new stats if missing
                            totalArtifactsFound: data.gameState?.totalArtifactsFound || 0,
                            totalArtifactsSold: data.gameState?.totalArtifactsSold || 0,
                            factionMissionsCompleted: {
                                'space-marines': 0,
                                'chaos': 0,
                                'orks': 0,
                                'eldar': 0,
                                'imperial-guard': 0,
                                ...data.gameState?.factionMissionsCompleted
                            },
                            factionGloryEarned: {
                                'space-marines': 0,
                                'chaos': 0,
                                'orks': 0,
                                'eldar': 0,
                                'imperial-guard': 0,
                                ...data.gameState?.factionGloryEarned
                            }
                        };
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                    // Try to load old format data if new format fails
                    try {
                        const oldData = localStorage.getItem('dutyEternalData');
                        if (oldData) {
                            const parsed = JSON.parse(oldData);
                            this.duties = parsed.duties || [];
                            this.missions = parsed.missions || [];
                            this.nextId = parsed.nextId || 1;
                            this.gameState = {
                                ...this.gameState,
                                ...parsed.gameState,
                                lastResolveRegeneration: Date.now(),
                                rankRequirements: {},
                                rankBenefits: {},
                                paragonBenefits: {
                                    maxResolve: 0,
                                    gloryMultiplier: 0,
                                    corruptionResistance: 0,
                                    artifactSlots: 0
                                },
                                hereticalBenefits: {},
                                redemptionProgress: 0,
                                factionBuffs: {
                                    zealStacks: 0,
                                    dutyStacks: 0,
                                    lastMissionTime: null,
                                    consecutiveMissions: 0,
                                    zealDuration: 0,
                                    waaaghUsedToday: false,
                                    lastDayReset: new Date().toDateString()
                                },
                                totalArtifactsFound: 0,
                                totalArtifactsSold: 0,
                                factionMissionsCompleted: {
                                    'space-marines': 0,
                                    'chaos': 0,
                                    'orks': 0,
                                    'eldar': 0,
                                    'imperial-guard': 0
                                },
                                factionGloryEarned: {
                                    'space-marines': 0,
                                    'chaos': 0,
                                    'orks': 0,
                                    'eldar': 0,
                                    'imperial-guard': 0
                                }
                            };
                        }
                    } catch (oldError) {
                        console.error('Error loading old format data:', oldError);
                    }
                }
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const app = new DutyEternal();
        });
    </script>
</body>
</html>
